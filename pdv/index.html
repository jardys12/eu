<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flokite System</title>
    <script>
        (function(){var d=localStorage.getItem('pdv_dark_theme')==='1';document.documentElement.setAttribute('data-theme',d?'dark':'light');})();
    </script>
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="assets/flokite-logo.jpeg">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script src="js/firebase-config.js"></script>
    <script src="js/firestore-service.js"></script>
    <script src="js/auth-service.js"></script>
    <script src="js/cloud-data-service.js"></script>
    <script src="js/storage-adapter.js"></script>
    <script src="js/migration-service.js"></script>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Responsive Overrides */
        @media (max-width: 768px) {
            .grid-cols-2, .grid-cols-4 {
                grid-template-columns: 1fr !important;
            }
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                z-index: 50;
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .app-header {
                padding: 10px;
            }
            .mobile-nav-toggle {
                display: block !important;
            }
            /* Touch Targets */
            button, .btn, .nav-item {
                min-height: 44px;
                min-width: 44px;
            }
        }
        
        .mobile-nav-toggle {
            display: none;
        }

        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-gray: #f3f4f6;
            --bg-card: #ffffff;
            --border: #e5e7eb;
            --text-dark: #1f2937;
            --text-muted: #6b7280;
            --danger: #ef4444;
            --success: #16a34a;
        }
        [data-theme="dark"] {
            --primary: #3b82f6;
            --primary-hover: #60a5fa;
            --bg-gray: #111827;
            --bg-card: #1f2937;
            --border: #374151;
            --text-dark: #f9fafb;
            --text-muted: #9ca3af;
        }
        [data-theme="dark"] body { background-color: var(--bg-gray); }
        [data-theme="dark"] .bg-white,
        [data-theme="dark"] .sidebar,
        [data-theme="dark"] .app-header,
        [data-theme="dark"] .mobile-nav-panel,
        [data-theme="dark"] .card,
        [data-theme="dark"] .table-container,
        [data-theme="dark"] .kpi-card,
        [data-theme="dark"] .customer-card,
        [data-theme="dark"] .cart-item,
        [data-theme="dark"] .payment-method-btn,
        [data-theme="dark"] .chip,
        [data-theme="dark"] .cart-item-btn,
        [data-theme="dark"] .modal-content { background-color: var(--bg-card) !important; border-color: var(--border); }
        [data-theme="dark"] th { background-color: #374151 !important; color: var(--text-muted); }
        [data-theme="dark"] tr:hover { background-color: #374151 !important; }
        [data-theme="dark"] .nav-item:hover,
        [data-theme="dark"] .nav-item.active { background-color: #374151 !important; color: var(--primary); }
        [data-theme="dark"] .payment-method-btn:hover,
        [data-theme="dark"] .payment-method-btn.selected { background: rgba(59,130,246,0.2) !important; border-color: var(--primary); }
        [data-theme="dark"] .chip.selected { background: rgba(59,130,246,0.2) !important; color: var(--primary); }
        [data-theme="dark"] .btn-secondary { background: #374151; border-color: var(--border); color: var(--text-dark); }
        [data-theme="dark"] .btn-secondary:hover { background: #4b5563; }
        [data-theme="dark"] .input,
        [data-theme="dark"] input.input { background: #111827; border-color: var(--border); color: var(--text-dark); }
        [data-theme="dark"] .input::placeholder { color: var(--text-muted); }
        [data-theme="dark"] .best-sellers-container { background: linear-gradient(to right, #1f2937, #111827); border-color: #374151; }
        [data-theme="dark"] .pix-display-box { background: #064e3b; border-color: #065f46; }
        [data-theme="dark"] .product-img { background-color: #374151; }
        [data-theme="dark"] .avatar { background: #374151; border-color: var(--border); }
        [data-theme="dark"] .text-gray-500 { color: var(--text-muted); }
        [data-theme="dark"] .nav-section { color: var(--text-muted); }
        [data-theme="dark"] .mobile-nav-header { border-color: var(--border); }
        [data-theme="dark"] #login-screen { background: linear-gradient(135deg, #1f2937, #111827) !important; }
        [data-theme="dark"] #login-screen .text-gray-500,
        [data-theme="dark"] #login-screen .text-xs { color: var(--text-muted); }
        [data-theme="dark"] .slider { background-color: #4b5563; }
        [data-theme="dark"] .btn-danger { background: #7f1d1d; border-color: #991b1b; color: #fca5a5; }
        [data-theme="dark"] .btn-danger:hover { background: #991b1b; }
        [data-theme="dark"] .badge-debt { background: #7f1d1d; color: #fecaca; }
        [data-theme="dark"] .badge-paid { background: #064e3b; color: #a7f3d0; }
        [data-theme="dark"] .shadow { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3), 0 2px 4px -1px rgba(0,0,0,0.2); }
        [data-theme="dark"] .bg-gray-50,
        [data-theme="dark"] main .overflow-auto { background-color: var(--bg-gray) !important; }
        [data-theme="dark"] #notif-dropdown,
        [data-theme="dark"] #notif-dropdown .bg-gray-50 { background: var(--bg-card) !important; border-color: var(--border); }
        [data-theme="dark"] .bg-gray-100 { background-color: #374151 !important; }
        [data-theme="dark"] .border-gray-100,
        [data-theme="dark"] .border-gray-200 { border-color: var(--border); }
        [data-theme="dark"] .text-gray-600,
        [data-theme="dark"] .text-gray-700,
        [data-theme="dark"] .text-gray-800,
        [data-theme="dark"] .text-gray-900 { color: var(--text-dark) !important; }
        [data-theme="dark"] .bg-blue-50 { background: rgba(59,130,246,0.2); }
        [data-theme="dark"] .text-blue-600 { color: var(--primary); }
        [data-theme="dark"] .hover\:bg-gray-100:hover { background: #374151 !important; }
        [data-theme="dark"] .divide-gray-200 > * + * { border-color: var(--border); }
        
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background-color: var(--bg-gray); height: 100vh; display: flex; flex-direction: column; }
        
        /* POS Category Section */
        .pos-category-section { margin-top: 3rem; margin-bottom: 0.75rem; }
        .pos-category-title { 
            font-size: 1.25rem; 
            font-weight: 800; 
            color: var(--text-dark); 
            border-bottom: 2px solid var(--border); 
            padding-bottom: 0.75rem; 
            margin-bottom: 1.25rem; 
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .pos-category-group {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            padding-bottom: 1.5rem;
            margin-bottom: 2rem;
            border-bottom: 1px dashed var(--border);
        }

        /* Best Sellers Section */
        .best-sellers-container {
            background: linear-gradient(to right, #ffffff, #f0f9ff);
            border: 1px solid #bae6fd;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 2rem;
        }
        .best-sellers-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; cursor: pointer; }

        /* Payment Modal Redesign */
        .payment-modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .payment-method-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 1rem; border: 2px solid var(--border); border-radius: 0.75rem;
            cursor: pointer; transition: all 0.2s; background: white; gap: 0.5rem;
        }
        .payment-method-btn:hover { border-color: var(--primary); background: #eff6ff; }
        .payment-method-btn.selected { border-color: var(--primary); background: #eff6ff; color: var(--primary); font-weight: bold; box-shadow: inset 0 0 0 2px var(--primary); }
        
        .pix-display-box {
            background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 0.5rem; padding: 1.5rem;
            text-align: center; margin-top: 1rem; display: flex; flex-direction: column; align-items: center; gap: 1rem;
        }
        .pos-chips { display: flex; gap: 0.5rem; overflow-x: auto; padding-bottom: 0.5rem; }
        .chip { padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: 999px; background: white; cursor: pointer; white-space: nowrap; font-size: 0.9rem; }
        .chip.selected { background: #eff6ff; color: var(--primary); border-color: var(--primary); font-weight: 600; }
        .brand-logo { width: 140px; height: auto; display: block; }
        .brand-logo-sm { width: 48px; height: auto; display: block; }
        /* Utils */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .justify-end { justify-content: flex-end; }
        .w-full { width: 100%; }
        .h-screen { height: 100vh; }
        .h-full { height: 100%; }
        .p-2 { padding: 0.5rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .gap-4 { gap: 1rem; }
        .gap-2 { gap: 0.5rem; }
        .border { border: 1px solid var(--border); }
        .rounded { border-radius: 0.5rem; }
        .bg-white { background-color: white; }
        .shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .text-xl { font-size: 1.25rem; font-weight: 600; }
        .text-lg { font-size: 1.125rem; font-weight: 600; }
        .text-sm { font-size: 0.875rem; }
        .font-bold { font-weight: 700; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .cursor-pointer { cursor: pointer; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-gray-500 { color: #6b7280; }
        .overflow-auto { overflow: auto; }
        .relative { position: relative; }

        /* Grid */
        .grid-cols-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .grid-cols-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        .grid-cols-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }
        @media (max-width: 1200px) {
            .grid-cols-4 { grid-template-columns: repeat(3, 1fr); }
            .grid-cols-3 { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .grid-cols-4 { grid-template-columns: repeat(2, 1fr); }
            .grid-cols-3 { grid-template-columns: 1fr; }
            .grid-cols-2 { grid-template-columns: 1fr; }
        }
        .compact .grid-cols-4 { grid-template-columns: repeat(2, 1fr); }
        .compact .grid-cols-3 { grid-template-columns: 1fr; }
        .compact .grid-cols-2 { grid-template-columns: 1fr; }
        .compact .payment-modal-grid { grid-template-columns: 1fr; }
        .compact .pos-category-group { grid-template-columns: repeat(2, 1fr); }
        .compact .btn { padding: 0.375rem 0.75rem; }
        .compact .text-lg { font-size: 1rem; }
        .compact .text-xl { font-size: 1.1rem; }
        
        /* Button */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: 1px solid transparent;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-danger { color: var(--danger); background: #fee2e2; border-color: #fecaca; }
        .btn-danger:hover { background: #fecaca; }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #15803d; }
        .btn-secondary { background: white; border-color: var(--border); color: var(--text-dark); }
        .btn-secondary:hover { background: var(--bg-gray); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(26px); }

        /* Input */
        .input-group { margin-bottom: 1rem; }
        .input-label { display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500; color: #4b5563; }
        .input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            font-size: 1rem;
        }
        .input:focus { outline: 2px solid var(--primary); border-color: transparent; }

        /* Sidebar */
        .sidebar { width: 250px; background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; position: relative; z-index: 10; }
        .sidebar-hidden .sidebar { display: none; }
        .sidebar-hidden main { width: 100%; }
        @media (max-width: 768px) {
            .sidebar { display: none; }
        }
        .nav-item {
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-dark);
            text-decoration: none;
            cursor: pointer;
            transition: background 0.1s;
        }
        .nav-item:hover, .nav-item.active { background-color: #eff6ff; color: var(--primary); border-right: 3px solid var(--primary); }
        .nav-section { padding: 0.5rem 1rem; font-size: 0.75rem; text-transform: uppercase; color: #6b7280; }
        * , *::before, *::after { box-sizing: border-box; }
        html, body { height: 100%; }
        body { margin: 0; background: var(--bg-gray); }
        .app-header { position: sticky; top: 0; z-index: 5; background: var(--bg-card); }

        /* Table */
        .table-container { border-radius: 0.5rem; border: 1px solid var(--border); overflow: hidden; background: white; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border); }
        th { background-color: #f9fafb; font-weight: 600; color: #6b7280; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f9fafb; }

        /* Cards */
        .card { background: white; border: 1px solid var(--border); border-radius: 0.5rem; padding: 1rem; }
        .product-card { 
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; 
            display: flex; flex-direction: column;
        }
        .stat-card { border: 0; border-radius: 0.75rem; padding: 1rem; color: #fff; display: flex; align-items: center; justify-content: space-between; }
        .stat-blue { background: linear-gradient(135deg,#2563eb,#1d4ed8); }
        .stat-green { background: linear-gradient(135deg,#10b981,#059669); }
        .stat-red { background: linear-gradient(135deg,#ef4444,#b91c1c); }
        .stat-yellow { background: linear-gradient(135deg,#f59e0b,#d97706); }
        .stat-icon { background: rgba(255,255,255,0.2); color: #fff; padding: 0.5rem; border-radius: 0.5rem; }
        .quick-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .kpi-grid { display: grid; grid-template-columns: repeat(4,minmax(0,1fr)); gap: 0.75rem; }
        @media (max-width: 768px) { .kpi-grid { grid-template-columns: repeat(2,minmax(0,1fr)); } }
        .kpi-card { background: #fff; border: 1px solid var(--border); border-radius: 0.5rem; padding: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
        .kpi-value { font-weight: 700; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 1rem; }
        @media (max-width: 1200px) { .dashboard-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
        @media (max-width: 768px) { .dashboard-grid { grid-template-columns: repeat(1, minmax(0, 1fr)); } }
        .dashboard-secondary-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 1rem; }
        @media (max-width: 768px) { .dashboard-secondary-grid { grid-template-columns: 1fr; } }
        .product-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-color: var(--primary); }
        .product-img { width: 100%; height: 120px; object-fit: cover; border-radius: 0.25rem; background-color: #f3f4f6; margin-bottom: 0.5rem; }
        .product-card.disabled { opacity: 0.6; cursor: not-allowed; pointer-events: none; }
        @media (max-width: 768px) {
            .pos-layout { flex-direction: column; }
            .pos-layout .w-96 { width: 100%; }
        }
        @media (max-width: 768px) {
            .fiado-layout { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .apagar-layout { grid-template-columns: 1fr; }
        }
        .compact .best-sellers-container { display: none; }
        .compact #pos-search { display: none; }
        .compact #sales-filters { display: none; }
        .compact #products-toolbar { display: none; }
        .compact #fiado-search { display: none; }
        .compact #apagar-search { display: none; }
        .compact .p-6 { padding: 0.75rem; }
        .compact .p-4 { padding: 0.5rem; }
        .compact .mb-6 { margin-bottom: 0.75rem; }
        .mobile-nav { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: stretch; justify-content: flex-start; z-index: 100; }
        .mobile-nav.open { display: flex; }
        .mobile-nav-panel { width: 80%; max-width: 320px; height: 100%; background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .mobile-nav-header { padding: 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .mobile-nav-items { padding: 0.5rem; display: flex; flex-direction: column; gap: 0.25rem; }
        @media (min-width: 769px) { .mobile-nav { display: none !important; } }

        /* Customers (Fiado) */
        .avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 1px solid var(--border); background: #f3f4f6; }
        .customer-card { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; background: white; cursor: pointer; transition: background 0.2s; }
        .customer-card:hover { background: #f9fafb; }
        .ledger-entry { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid var(--border); }
        .ledger-entry:last-child { border-bottom: none; }
        .badge { display: inline-block; font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 999px; }
        .badge-debt { background: #fee2e2; color: #991b1b; }
        .badge-paid { background: #dcfce7; color: #065f46; }
        .balance-positive { color: #b91c1c; font-weight: 700; }
        .balance-zero { color: #065f46; font-weight: 700; }

        /* POS Cart Touch Friendly */
        .cart-item-btn { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 1px solid var(--border); background: white; cursor: pointer; transition: all 0.2s; }
        .cart-item-btn:hover { background: var(--bg-gray); border-color: var(--primary); color: var(--primary); }
        .cart-item-btn:active { transform: scale(0.95); }
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            background: white;
            transition: background 0.2s;
        }
        .cart-item:last-child { border-bottom: none; }
        .cart-item:hover { background: #f9fafb; }
        .cart-item-info { flex: 1; margin-right: 0.5rem; }
        .cart-item-title { font-weight: 600; font-size: 0.95rem; color: var(--text-dark); display: block; line-height: 1.2; margin-bottom: 4px; }
        .cart-item-meta { font-size: 0.85rem; color: #6b7280; }
        .cart-controls { display: flex; align-items: center; gap: 0.75rem; background: #f3f4f6; padding: 4px; border-radius: 20px; }
        .cart-qty { font-weight: bold; min-width: 20px; text-align: center; font-size: 0.9rem; }

        
        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-height: 90vh;
            overflow-y: auto;
        }
        @media (max-width: 480px) {
            .modal-content { max-width: 95vw; width: 95vw; padding: 1rem; }
        }

    </style>
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <!-- TELA DE LOGIN / REGISTRO -->
    <div id="login-screen" class="flex items-center justify-center h-screen" style="background: linear-gradient(135deg, #eff6ff, #f3f4f6);">
        <div class="bg-white p-8 rounded shadow border" style="width: 100%; max-width: 500px; margin: 16px;">
            <div class="flex flex-col items-center mb-6">
                <img src="./assets/flokite-logo.jpeg?v=1" alt="Logo Flokite System" class="brand-logo" onerror="this.onerror=null; this.src='https://via.placeholder.com/140x140?text=Logo';">
                <h2 class="text-xl mt-3" style="color: var(--primary); font-weight: 700;">Flokite System</h2>
                <p class="text-sm text-gray-500">O melhor para sua gestão de vendas</p>
            </div>

            <!-- Tabs -->
            <div class="flex border-b mb-4">
                <button id="tab-login" class="flex-1 py-2 text-center border-b-2 border-blue-500 font-bold text-blue-600" onclick="switchAuthTab('login')">Entrar</button>
                <button id="tab-register" class="flex-1 py-2 text-center border-b-2 border-transparent text-gray-500" onclick="switchAuthTab('register')">Cadastrar</button>
            </div>

            <!-- Login Form -->
            <form id="login-form" class="flex flex-col gap-4">
                <div>
                    <label class="input-label">Email</label>
                    <input type="email" id="email" class="input" placeholder="seu@email.com">
                </div>
                <div>
                    <label class="input-label">Senha</label>
                    <input type="password" id="password" class="input" placeholder="********">
                    <div class="text-right mt-1">
                        <button type="button" onclick="openForgotPasswordModal()" class="text-xs text-blue-600 hover:underline border-none bg-transparent cursor-pointer">Esqueceu a senha?</button>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary w-full justify-center">Entrar</button>
                <div class="text-center text-xs text-gray-500 my-1">OU</div>
                <button type="button" class="btn btn-secondary w-full justify-center flex items-center gap-2" onclick="handleGoogleLogin()">
                    <i data-lucide="chrome"></i> Entrar com Google
                </button>
            </form>

            <!-- Register Form (Hidden) -->
            <form id="register-form" class="flex flex-col gap-4 hidden">
                <div>
                    <label class="input-label">Email</label>
                    <input type="email" id="reg-email" class="input" placeholder="seu@email.com">
                </div>
                <div>
                    <label class="input-label">Senha</label>
                    <input type="password" id="reg-password" class="input" placeholder="Mínimo 8 caracteres">
                </div>
                <div>
                    <label class="input-label">Confirmar Senha</label>
                    <input type="password" id="reg-confirm-password" class="input" placeholder="Confirme a senha">
                </div>
                <div class="text-xs text-gray-500">
                    A senha deve ter 8+ caracteres, maiúscula, minúscula, número e símbolo.
                </div>
                <button type="submit" class="btn btn-primary w-full justify-center">Cadastrar</button>
            </form>

            <div class="mt-4 flex items-center justify-center gap-2">
                 <button type="button" id="login-dark-toggle" class="btn btn-sm btn-secondary flex items-center gap-2" onclick="toggleDarkMode(); if(typeof lucide!='undefined')lucide.createIcons();" title="Alternar modo escuro">
                    <i data-lucide="moon" id="login-icon-moon" class="w-4 h-4"></i>
                    <i data-lucide="sun" id="login-icon-sun" class="w-4 h-4 hidden"></i>
                    <span>Modo escuro</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="modal-overlay hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center;">
        <div class="modal-content bg-white p-6 rounded shadow-lg" style="width: 100%; max-width: 400px;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">Recuperar Senha</h3>
                <button onclick="closeForgotPasswordModal()" class="text-gray-500 hover:text-gray-700"><i data-lucide="x"></i></button>
            </div>
            <p class="text-sm text-gray-600 mb-4">Digite seu email para receber um link de redefinição de senha.</p>
            <form id="forgot-password-form" class="flex flex-col gap-4">
                <div>
                    <label class="input-label">Email</label>
                    <input type="email" id="forgot-email" class="input" placeholder="seu@email.com" required>
                </div>
                <button type="submit" class="btn btn-primary w-full justify-center">Enviar Email</button>
            </form>
        </div>
    </div>

    <div id="mobile-nav" class="mobile-nav hidden">
        <div class="mobile-nav-panel">
            <div class="mobile-nav-header">
                <div class="flex items-center gap-2">
                    <i data-lucide="store" class="text-blue-600"></i>
                    <span class="font-bold">Flokite System</span>
                </div>
                <button class="btn btn-sm btn-secondary" onclick="closeMobileNav()"><i data-lucide="x"></i> Fechar</button>
            </div>
            <div class="mobile-nav-items">
                <div id="mob-nav-home" class="nav-item" onclick="navigate('home'); closeMobileNav();"><i data-lucide="home"></i> Resumo</div>
                <div id="mob-nav-pos" class="nav-item" onclick="navigate('pos'); closeMobileNav();"><i data-lucide="dollar-sign"></i> Caixa</div>
                <div id="mob-nav-sales" class="nav-item" onclick="navigate('sales'); closeMobileNav();"><i data-lucide="shopping-cart"></i> Vendas</div>
                <div id="mob-nav-clientes" class="nav-item" onclick="navigate('fiado'); closeMobileNav();"><i data-lucide="users"></i> Clientes</div>
                <div id="mob-nav-produtos" class="nav-item" onclick="navigate('products'); closeMobileNav();"><i data-lucide="package"></i> Produtos</div>
                <div id="mob-nav-estoque" class="nav-item" onclick="navigate('products'); closeMobileNav();"><i data-lucide="warehouse"></i> Estoque</div>
                <div id="mob-nav-crediario" class="nav-item" onclick="navigate('fiado'); closeMobileNav();"><i data-lucide="credit-card"></i> Fiados</div>
                <div class="nav-section">Financeiro</div>
                <div id="mob-nav-apagar" class="nav-item" onclick="navigate('apagar'); closeMobileNav();"><i data-lucide="arrow-down-circle"></i> Contas a Pagar</div>
                <div id="mob-nav-areceber" class="nav-item" onclick="navigate('fiado'); closeMobileNav();"><i data-lucide="arrow-up-circle"></i> Contas a Receber</div>
                <div id="mob-nav-reports" class="nav-item" onclick="navigate('reports'); closeMobileNav();"><i data-lucide="bar-chart-2"></i> Relatórios</div>
                <div id="mob-nav-settings" class="nav-item" onclick="navigate('settings'); closeMobileNav();"><i data-lucide="settings"></i> Configurações</div>
                <div class="nav-item" style="color: var(--danger);" onclick="logout(); closeMobileNav();"><i data-lucide="log-out"></i> Sair</div>
            </div>
        </div>
        <div class="flex-1" onclick="closeMobileNav()"></div>
    </div>
    <!-- TELA DE DASHBOARD (Layout) -->
    <div id="dashboard-screen" class="hidden h-screen flex">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="p-6 border-b flex items-center gap-2">
                <i data-lucide="store" class="text-blue-600"></i>
                <h2 class="text-xl" style="color: var(--primary);">Flokite System</h2>
            </div>
            <nav class="flex-1 p-4 flex flex-col gap-1">
                <div id="nav-home" class="nav-item active" onclick="navigate('home')">
                    <i data-lucide="home"></i> Resumo
                </div>
                <div id="nav-pos" class="nav-item" onclick="navigate('pos')">
                    <i data-lucide="dollar-sign"></i> Caixa
                </div>
                <div id="nav-sales" class="nav-item" onclick="navigate('sales')">
                    <i data-lucide="shopping-cart"></i> Vendas
                </div>
                <div id="nav-clientes" class="nav-item" onclick="navigate('fiado')">
                    <i data-lucide="users"></i> Clientes
                </div>
                <div id="nav-produtos" class="nav-item" onclick="navigate('products')">
                    <i data-lucide="package"></i> Produtos
                </div>
                <div id="nav-estoque" class="nav-item" onclick="navigate('products')">
                    <i data-lucide="warehouse"></i> Estoque
                </div>
                <div id="nav-crediario" class="nav-item" onclick="navigate('fiado')">
                    <i data-lucide="credit-card"></i> Fiados
                </div>
                <div class="nav-section">Financeiro</div>
                <div id="nav-apagar" class="nav-item" onclick="navigate('apagar')">
                    <i data-lucide="arrow-down-circle"></i> Contas a Pagar
                </div>
                <div id="nav-areceber" class="nav-item" onclick="navigate('fiado')">
                    <i data-lucide="arrow-up-circle"></i> Contas a Receber
                </div>
                <div id="nav-reports" class="nav-item" onclick="navigate('reports')">
                    <i data-lucide="bar-chart-2"></i> Relatórios
                </div>
                <div id="nav-settings" class="nav-item" onclick="navigate('settings')">
                    <i data-lucide="settings"></i> Configurações
                </div>
            </nav>
            <div class="p-4 border-t">
                <div class="nav-item" style="color: var(--danger);" onclick="logout()">
                    <i data-lucide="log-out"></i> Sair
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-auto">
            <header class="app-header border-b p-4 flex justify-between items-center">
                <h3 id="page-title" class="font-semibold text-xl">Visão Geral</h3>
                <div class="flex items-center gap-2">
                    <div class="relative mr-2" id="notification-bell">
                        <button class="btn btn-sm btn-secondary p-2 rounded-full" onclick="toggleNotifications()">
                            <i data-lucide="bell"></i>
                            <span id="notif-badge" class="absolute -top-1 -right-1 bg-red-600 text-white text-xs font-bold px-1.5 py-0.5 rounded-full hidden">0</span>
                        </button>
                        <!-- Dropdown -->
                        <div id="notif-dropdown" class="absolute right-0 mt-2 w-80 bg-white border rounded shadow-lg z-50 hidden">
                            <div class="p-3 border-b font-bold flex justify-between items-center bg-gray-50">
                                <span>Notificações</span>
                                <button class="text-xs text-blue-600 hover:underline" onclick="markAllRead()">Limpar</button>
                            </div>
                            <div id="notif-list" class="max-h-64 overflow-y-auto">
                                <div class="p-4 text-center text-gray-500 text-sm">Nenhuma notificação nova.</div>
                            </div>
                        </div>
                    </div>
                    <button id="dark-mode-btn" class="btn btn-sm btn-secondary p-2 rounded-full" onclick="toggleDarkMode()" title="Modo escuro">
                        <i data-lucide="moon" id="dark-mode-icon-moon" class="w-4 h-4"></i>
                        <i data-lucide="sun" id="dark-mode-icon-sun" class="w-4 h-4 hidden"></i>
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="toggleCompact()"><i data-lucide="minimize-2"></i> Compactar</button>
                    <button class="btn btn-sm btn-secondary" onclick="handleMenuButton()"><i data-lucide="panel-left-close"></i> Menu</button>
                </div>
                <div class="flex items-center gap-2 bg-gray-100 p-2 rounded">
                    <div style="width: 32px; height: 32px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); font-weight: bold; border: 1px solid var(--border);">A</div>
                    <span class="font-medium text-sm">Administrador</span>
                </div>
            </header>
            
            <div class="p-6 overflow-auto flex-1 bg-gray-50">
                
                <!-- Page: Home -->
                <div id="page-home">
                    <!-- Header Customizado -->
                    <div class="bg-white -mx-6 -mt-6 p-6 pb-6 rounded-b-3xl shadow-sm border-b border-gray-100 mb-6 flex justify-between items-center">
                        <div>
                             <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">Meu sistema PDV</h1>
                             <p class="text-gray-500 text-sm mt-1 font-medium">Bem-vindo, Administrador</p>
                        </div>
                        <div class="flex items-center bg-gray-50 rounded-lg border border-gray-200 shadow-sm overflow-hidden divide-x divide-gray-200">
                             <button class="p-3 hover:bg-gray-100 transition-colors group" onclick="location.reload()" title="Atualizar">
                                 <i data-lucide="rotate-cw" class="w-5 h-5 text-gray-700 group-hover:text-black"></i>
                             </button>
                             <button class="p-3 hover:bg-gray-100 transition-colors group" onclick="toggleCompact()" title="Visualização">
                                 <i data-lucide="eye" class="w-5 h-5 text-gray-700 group-hover:text-black"></i>
                             </button>
                             <button class="p-3 hover:bg-gray-100 transition-colors group" onclick="navigate('settings')" title="Backup/Config">
                                 <i data-lucide="cloud" class="w-5 h-5 text-gray-700 group-hover:text-black"></i>
                             </button>
                             <button class="p-3 hover:bg-gray-100 transition-colors group" onclick="logout()" title="Sair">
                                 <i data-lucide="log-out" class="w-5 h-5 text-gray-700 group-hover:text-red-600"></i>
                             </button>
                        </div>
                    </div>

                    <!-- KPI Cards (Moved up to overlap or sit nicely) -->
                    <div class="grid grid-cols-2 gap-4 mb-6 -mt-8 px-2">
                        <div class="bg-white p-4 rounded-2xl shadow-lg border border-gray-100 flex flex-col justify-between h-32">
                            <p class="text-gray-600 font-bold text-sm">Vendas</p>
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800" id="home-sales-total">R$ 0,00</h2>
                                <p class="text-xs text-gray-500 mt-1" id="home-sales-count">Hoje - 0 vendas realizadas</p>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-2xl shadow-lg border border-gray-100 flex flex-col justify-between h-32">
                             <p class="text-gray-600 font-bold text-sm">Totais em caixa</p>
                             <div>
                                 <h2 class="text-2xl font-bold text-gray-800" id="home-cash-total">R$ 0,00</h2>
                                 <p class="text-xs text-gray-500 mt-1" id="current-datetime">--/--/---- --:--</p>
                             </div>
                        </div>
                    </div>

                    <!-- Main Menu Grid -->
                    <div class="grid grid-cols-4 gap-4 mb-6 px-2">
                        <!-- Caixa -->
                        <div onclick="navigate('pos')" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 cursor-pointer hover:shadow-md transition-all h-28">
                            <div class="p-3 bg-blue-50 text-blue-600 rounded-full">
                                <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                            </div>
                            <span class="font-medium text-gray-700 text-sm">Caixa</span>
                        </div>
                        
                        <!-- Mesas - REMOVED -->
                        <!-- Delivery - REMOVED -->

                        <!-- Estoque -->
                        <div onclick="navigate('products')" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 cursor-pointer hover:shadow-md transition-all h-28">
                            <div class="p-3 bg-purple-50 text-purple-600 rounded-full">
                                <i data-lucide="package" class="w-6 h-6"></i>
                            </div>
                            <span class="font-medium text-gray-700 text-sm">Estoque</span>
                        </div>

                        <!-- Produtos -->
                        <div onclick="navigate('products')" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 cursor-pointer hover:shadow-md transition-all h-28">
                            <div class="p-3 bg-indigo-50 text-indigo-600 rounded-full">
                                <i data-lucide="tag" class="w-6 h-6"></i>
                            </div>
                            <span class="font-medium text-gray-700 text-sm">Produtos</span>
                        </div>

                        <!-- Clientes -->
                        <div onclick="navigate('fiado')" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 cursor-pointer hover:shadow-md transition-all h-28">
                            <div class="p-3 bg-pink-50 text-pink-600 rounded-full">
                                <i data-lucide="users" class="w-6 h-6"></i>
                            </div>
                            <span class="font-medium text-gray-700 text-sm">Clientes</span>
                        </div>

                        <!-- Relatórios -->
                        <div onclick="navigate('reports')" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 cursor-pointer hover:shadow-md transition-all h-28">
                            <div class="p-3 bg-teal-50 text-teal-600 rounded-full">
                                <i data-lucide="bar-chart-2" class="w-6 h-6"></i>
                            </div>
                            <span class="font-medium text-gray-700 text-sm">Relatórios</span>
                        </div>

                        <!-- Config -->
                        <div onclick="navigate('settings')" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 cursor-pointer hover:shadow-md transition-all h-28">
                            <div class="p-3 bg-gray-100 text-gray-600 rounded-full">
                                <i data-lucide="settings" class="w-6 h-6"></i>
                            </div>
                            <span class="font-medium text-gray-700 text-sm">Config</span>
                        </div>
                    </div>

                    <!-- Alerts Section -->
                    <div class="mb-6 px-2">
                        <h3 class="text-lg font-bold text-gray-800 mb-3">Alertas</h3>
                        <div id="home-alerts-list" class="flex flex-col gap-3">
                             <!-- JS Populates -->
                        </div>
                    </div>
                </div>

                <!-- Page: Tables (REMOVED) -->
                <!-- Page: Delivery (REMOVED) -->

                <!-- Page: PDV (Vendas) -->
                <div id="page-pos" class="hidden h-full flex flex-col">
                    <div class="flex-1 flex flex-col">
                        <div class="mb-4">
                            <input type="text" id="pos-search" class="input" placeholder="Buscar produto..." onkeyup="filterPosProducts()">
                        </div>
                        <div id="pos-categories" class="pos-chips"></div>
                        <div class="overflow-auto">
                            <div id="pos-grid" class="grid-cols-4">
                                <!-- JS Populates -->
                            </div>
                        </div>
                        <div class="mt-6 bg-white border rounded shadow flex flex-col">
                            <div class="p-4 border-b bg-gray-50">
                                <h3 class="font-bold text-lg flex items-center gap-2">
                                    <i data-lucide="shopping-cart" size="20"></i> Carrinho
                                </h3>
                            </div>
                            <div class="flex-1 overflow-auto p-4" id="cart-items">
                                <div class="text-center text-gray-500 mt-10">Carrinho vazio</div>
                            </div>
                            <div class="p-4 border-t bg-gray-50">
                                <div class="flex justify-between mb-2">
                                    <span>Subtotal</span>
                                    <span id="cart-subtotal">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between mb-4 text-xl font-bold text-blue-700">
                                    <span>Total</span>
                                    <span id="cart-total">R$ 0,00</span>
                                </div>
                                <button class="btn btn-success w-full py-3 text-lg" onclick="openPaymentModal()" id="btn-checkout" disabled>
                                    Finalizar Venda
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal: Delivery Info (REMOVED) -->

                <!-- Modal: Detalhes do Mês -->
                <div id="month-details-modal" class="modal-overlay hidden">
                    <div class="modal-content">
                        <h2 class="text-xl font-bold">Entradas do Mês</h2>
                        <div id="month-details-content" class="mt-4"></div>
                        <div class="mt-4 flex justify-end">
                            <button class="btn btn-secondary" onclick="closeMonthDetails()"><i data-lucide="x"></i> Fechar</button>
                        </div>
                    </div>
                </div>

                <!-- Page: Reports -->
                <div id="page-reports" class="hidden">
                    <h1 class="text-2xl font-bold text-gray-800 mb-6">Relatórios Gerenciais</h1>
                    
                    <div class="grid-cols-2 mb-6">
                        <div class="bg-white p-6 rounded shadow border">
                            <h3 class="font-bold text-lg mb-4 text-gray-700">Fluxo de Caixa (Entradas vs Saídas)</h3>
                            <div class="flex items-center justify-between mb-4">
                                <div class="text-center">
                                    <p class="text-sm text-gray-500">Entradas (Vendas)</p>
                                    <p id="rep-income" class="text-xl font-bold text-green-600">R$ 0,00</p>
                                </div>
                                <div class="text-2xl text-gray-300">-</div>
                                <div class="text-center">
                                    <p class="text-sm text-gray-500">Saídas (Pagas)</p>
                                    <p id="rep-expenses" class="text-xl font-bold text-red-600">R$ 0,00</p>
                                </div>
                                <div class="text-2xl text-gray-300">=</div>
                                <div class="text-center">
                                    <p class="text-sm text-gray-500">Saldo</p>
                                    <p id="rep-balance" class="text-xl font-bold text-blue-600">R$ 0,00</p>
                                </div>
                            </div>
                            <canvas id="chart-cashflow" style="max-height: 250px;"></canvas>
                        </div>
                        <div class="bg-white p-6 rounded shadow border">
                            <h3 class="font-bold text-lg mb-4 text-gray-700">Vendas por Forma de Pagamento</h3>
                            <canvas id="chart-payment-methods" style="max-height: 250px;"></canvas>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded shadow border">
                        <h3 class="font-bold text-lg mb-4 text-gray-700">Produtos Mais Vendidos (Top 5)</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="text-left border-b text-gray-500 text-sm">
                                        <th class="pb-2">Produto</th>
                                        <th class="pb-2">Qtd. Vendida</th>
                                        <th class="pb-2">Total (R$)</th>
                                    </tr>
                                </thead>
                                <tbody id="rep-top-products">
                                    <!-- JS Populates -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Page: À pagar -->
                <div id="page-apagar" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl font-bold text-gray-800">À pagar</h1>
                        <div class="flex gap-2">
                            <button class="btn btn-primary" onclick="openPayableModal()">
                                <i data-lucide="plus-circle"></i> Nova Conta a Pagar
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid-cols-3">
                        <div class="bg-white p-4 rounded border">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold">Categorias</h3>
                                <button class="btn btn-sm btn-primary" onclick="addPayableCategory()">
                                    <i data-lucide="plus"></i> Adicionar
                                </button>
                            </div>
                            <ul id="apagar-categories-list" class="flex flex-col gap-2"></ul>
                        </div>
                        <div class="bg-white p-4 rounded border col-span-2">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold">Contas por Categoria</h3>
                                <input type="text" id="apagar-search" class="input" placeholder="Buscar conta..." onkeyup="renderApagarGrid()">
                            </div>
                            <div id="apagar-grid" class="grid-cols-3"></div>
                        </div>
                    </div>

                    <div class="mt-6 bg-white p-4 rounded border">
                        <h3 class="text-lg font-bold mb-4">Detalhes da Conta</h3>
                        <div id="apagar-detail-empty" class="text-gray-500 text-center p-8">
                            Selecione uma conta para ver os detalhes
                        </div>
                        <div id="apagar-detail" class="hidden">
                            <div class="flex items-center gap-3 mb-4">
                                <img id="payable-photo" class="avatar" src="" alt="Foto">
                                <div class="flex-1">
                                    <h3 id="payable-name" class="text-lg font-bold"></h3>
                                    <p id="payable-category" class="text-sm text-gray-500"></p>
                                </div>
                                <div class="flex gap-2">
                                    <button class="btn btn-sm btn-secondary" onclick="openPayableModal(currentPayableId)"><i data-lucide="edit-2"></i> Editar</button>
                                    <button class="btn btn-sm btn-danger" onclick="deletePayable(currentPayableId)"><i data-lucide="trash"></i> Remover</button>
                                </div>
                            </div>
                            <div class="grid-cols-3">
                                <div class="card">
                                    <div class="text-sm text-gray-500">Data de Pagamento</div>
                                    <div id="payable-due" class="font-bold"></div>
                                </div>
                                <div class="card">
                                    <div class="text-sm text-gray-500">Total</div>
                                    <div id="payable-total" class="font-bold text-blue-700"></div>
                                </div>
                                <div class="card">
                                    <div class="text-sm text-gray-500">Pago</div>
                                    <div id="payable-paid" class="font-bold text-green-700"></div>
                                </div>
                            </div>
                            <div class="mt-4">
                                <div class="text-sm text-gray-500">Falta Pagar</div>
                                <div id="payable-remaining" class="font-bold text-red-700"></div>
                            </div>
                            <div class="mt-6">
                                <h4 class="font-bold mb-3 flex items-center gap-2"><i data-lucide="wallet"></i> Pagamentos</h4>
                                <div id="payable-ledger"></div>
                                <div class="mt-4 flex gap-2">
                                    <input type="number" id="apagar-payment-amount" class="input" step="0.01" min="0" placeholder="Valor pago (R$)">
                                    <input type="date" id="apagar-payment-date" class="input">
                                    <button class="btn btn-success" onclick="addPayablePayment()"><i data-lucide="plus"></i> Registrar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Page: Sales History -->
                <div id="page-sales" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl font-bold text-gray-800">Histórico de Vendas</h1>
                        
                    <div class="flex gap-2" id="sales-filters">
                        <button class="btn btn-sm btn-secondary" onclick="filterSales('day')">Hoje</button>
                        <button class="btn btn-sm btn-secondary" onclick="filterSales('month')">Este Mês</button>
                        <button class="btn btn-sm btn-secondary" onclick="filterSales('year')">Este Ano</button>
                        <button class="btn btn-sm btn-secondary" onclick="filterSales('all')">Todos</button>
                        <button class="btn btn-sm btn-secondary" onclick="exportSalesCSV()" title="Exportar para Excel"><i data-lucide="file-spreadsheet" style="width:16px;height:16px;"></i> CSV</button>
                        <button class="btn btn-sm btn-secondary" onclick="exportSalesPDF()" title="Exportar para PDF"><i data-lucide="file-text" style="width:16px;height:16px;"></i> PDF</button>
                    </div>
                    </div>

                    <div class="flex gap-4 mb-4">
                        <div class="card p-4 flex-1">
                            <p class="text-sm text-gray-500">Vendas no Período</p>
                            <h3 class="text-2xl font-bold" id="sales-count">0</h3>
                        </div>
                        <div class="card p-4 flex-1">
                            <p class="text-sm text-gray-500">Total Faturado</p>
                            <h3 class="text-2xl font-bold text-green-600" id="sales-total">R$ 0,00</h3>
                        </div>
                        <div class="card p-4 flex-1">
                            <p class="text-sm text-gray-500">Clientes Devendo</p>
                            <h3 class="text-2xl font-bold text-red-600" id="sales-debtors-count">0</h3>
                            <p class="text-sm text-gray-500 mt-1">Total em Fiado: <span id="sales-debtors-total">R$ 0,00</span></p>
                        </div>
                    </div>

                    <div class="table-container shadow">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Data</th>
                                    <th>Itens</th>
                                    <th>Forma Pagamento</th>
                                    <th>Total</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="sales-table-body">
                                <!-- JS Populates -->
                            </tbody>
                        </table>
                        <div id="sales-empty-state" class="hidden p-8 text-center text-gray-500">
                            <i data-lucide="calendar-x" style="width: 48px; height: 48px; margin-bottom: 1rem; color: #9ca3af;"></i>
                            <p>Nenhuma venda encontrada neste período.</p>
                        </div>
                        
                        <div class="mt-6">
                            <h3 class="font-bold text-lg mb-2 text-gray-700">Clientes com Fiado em Aberto</h3>
                            <div id="sales-debtors-list" class="grid-cols-3">
                                <!-- JS Populates -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page: Products -->
                <div id="page-products" class="hidden">
                    <div class="flex justify-between items-center mb-6" id="products-toolbar">
                        <h1 class="text-2xl font-bold text-gray-800">Gerenciar Produtos</h1>
                        <div class="flex gap-2 items-center">
                            <button class="btn btn-sm btn-secondary" onclick="exportProductsCSV()" title="Exportar para Excel"><i data-lucide="file-spreadsheet" style="width:16px;height:16px;"></i> Exportar CSV</button>
                            <button class="btn btn-sm btn-secondary" onclick="exportProductsPDF()" title="Exportar para PDF"><i data-lucide="file-text" style="width:16px;height:16px;"></i> Exportar PDF</button>
                            <button class="btn btn-primary" onclick="openProductModal()">
                                <i data-lucide="plus"></i> Novo Produto
                            </button>
                        </div>
                    </div>

                    <div class="table-container shadow">
                        <table id="products-table">
                            <thead>
                                <tr>
                                    <th>Imagem</th>
                                    <th>Nome do Produto</th>
                                    <th>Preço Unitário</th>
                                    <th>Estoque Atual</th>
                                    <th>Valor Total</th>
                                    <th style="text-align: right;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="products-table-body">
                                <!-- JS will populate this -->
                            </tbody>
                        </table>
                        <div id="empty-state" class="hidden p-8 text-center text-gray-500">
                            <i data-lucide="package-open" style="width: 48px; height: 48px; margin-bottom: 1rem; color: #9ca3af;"></i>
                            <p>Nenhum produto cadastrado.</p>
                        </div>
                        <div id="products-card-list" class="hidden flex flex-col gap-2 p-2"></div>
                    </div>
                </div>

                <!-- Page: Fiado (Clientes) -->
                <div id="page-fiado" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl font-bold text-gray-800">Fiado (Clientes)</h1>
                        <button class="btn btn-primary" onclick="openCustomerModal()">
                            <i data-lucide="user-plus"></i> Adicionar Cliente
                        </button>
                    </div>
                    
                    <div class="grid-cols-2 fiado-layout">
                        <!-- Lista de Clientes -->
                        <div class="bg-white p-4 rounded border">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold">Clientes</h3>
                                <input type="text" id="fiado-search" class="input" placeholder="Buscar cliente..." onkeyup="renderCustomerList()">
                            </div>
                            <div id="customers-list" class="flex flex-col gap-2">
                                <!-- JS Populates -->
                            </div>
                        </div>
                        
                        <!-- Perfil do Cliente -->
                        <div class="bg-white p-4 rounded border">
                            <div id="customer-detail-empty" class="text-gray-500 text-center p-8">
                                Selecione um cliente para ver o perfil
                            </div>
                            <div id="customer-detail" class="hidden">
                                <div class="flex items-center gap-3 mb-4">
                                    <img id="cust-photo" class="avatar" src="" alt="Foto">
                                    <div>
                                        <h3 id="cust-name" class="text-lg font-bold"></h3>
                                        <p id="cust-balance" class="text-sm"></p>
                                        <p id="cust-credit-limit" class="text-xs text-gray-500"></p>
                                    </div>
                                    <div class="flex gap-2 ml-auto">
                                        <button class="btn btn-sm btn-secondary" onclick="openCustomerModal(currentCustomerId)">
                                            <i data-lucide="edit-2"></i> Editar
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteCustomer(currentCustomerId)">
                                            <i data-lucide="trash"></i> Remover
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="grid-cols-2">
                                    <div class="card">
                                        <h4 class="font-bold mb-3 flex items-center gap-2"><i data-lucide="receipt"></i> Fiados</h4>
                                        <div id="cust-ledger-fiado"></div>
                                    </div>
                                    <div class="card">
                                        <h4 class="font-bold mb-3 flex items-center gap-2"><i data-lucide="wallet"></i> Pagamentos</h4>
                                        <div id="cust-ledger-payments"></div>
                                        <div class="mt-4 flex gap-2">
                                            <input type="number" id="payment-amount" class="input" step="0.01" min="0" placeholder="Valor pago (R$)">
                                            <button class="btn btn-success" onclick="addCustomerPayment()"><i data-lucide="plus"></i> Registrar</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                

                <!-- Page: Settings -->
                <div id="page-settings" class="hidden">
                    <h1 class="text-2xl font-bold text-gray-800 mb-6">Configurações</h1>
                    
                    <div class="card max-w-2xl mb-6">
                        <div class="flex justify-between items-center mb-4 border-b pb-4">
                            <h3 class="text-lg font-bold">Categorias de Produtos</h3>
                            <button class="btn btn-sm btn-primary" onclick="addCategory()">
                                <i data-lucide="plus"></i> Adicionar
                            </button>
                        </div>
                        <ul id="categories-list" class="flex flex-col gap-2">
                            <!-- JS Populates -->
                        </ul>
                    </div>

                    <div class="card max-w-2xl">
                        <div class="flex justify-between items-center mb-4 border-b pb-4">
                            <h3 class="text-lg font-bold">Formas de Pagamento</h3>
                            <button class="btn btn-sm btn-primary" onclick="addPaymentMethod()">
                                <i data-lucide="plus"></i> Adicionar
                            </button>
                        </div>
                        <ul id="payment-methods-list" class="flex flex-col gap-2">
                            <!-- JS Populates -->
                        </ul>
                    </div>

                    <div class="card max-w-2xl mt-6">
                        <div class="flex justify-between items-center mb-4 border-b pb-4">
                            <h3 class="text-lg font-bold flex items-center gap-2"><i data-lucide="qr-code" class="text-green-600"></i> Configuração Pix</h3>
                        </div>
                        <div class="flex flex-col gap-4">
                            <div class="input-group">
                                <label class="input-label">Chave Pix (CPF, Email, Telefone, etc)</label>
                                <input type="text" id="config-pix-key" class="input" placeholder="Ex: 123.456.789-00">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Nome do Beneficiário</label>
                                <input type="text" id="config-pix-name" class="input" placeholder="Ex: João Silva">
                            </div>
                            <div class="input-group">
                                <label class="input-label">QR Code Pix (imagem)</label>
                                <input type="file" id="config-pix-qr-file" class="input" accept="image/*">
                                <div id="config-pix-qr-preview" class="mt-2"></div>
                            </div>
                            <button class="btn btn-primary self-end" onclick="savePixConfig()">
                                <i data-lucide="save"></i> Salvar Pix
                            </button>
                        </div>
                    </div>

                    <div class="card max-w-2xl mt-6">
                        <div class="flex justify-between items-center mb-4 border-b pb-4">
                            <h3 class="text-lg font-bold flex items-center gap-2"><i data-lucide="credit-card" class="text-blue-600"></i> Integrações de Pagamento</h3>
                        </div>
                        <div class="flex flex-col gap-4">
                            <div class="input-group">
                                <label class="input-label">Stripe Payment Link (URL)</label>
                                <input type="url" id="config-stripe-link" class="input" placeholder="https://buy.stripe.com/...">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Mercado Pago Checkout (URL)</label>
                                <input type="url" id="config-mp-link" class="input" placeholder="https://www.mercadopago.com.br/checkout/...">
                            </div>
                            <button class="btn btn-primary self-end" onclick="saveIntegrations()">
                                <i data-lucide="save"></i> Salvar Integrações
                            </button>
                        </div>
                    </div>

                    <div class="card max-w-2xl mt-6">
                        <div class="flex justify-between items-center mb-4 border-b pb-4">
                            <h3 class="text-lg font-bold flex items-center gap-2"><i data-lucide="settings" class="text-gray-700"></i> Administração (Usuários)</h3>
                            <button class="btn btn-sm btn-primary" onclick="addUser()">
                                <i data-lucide="user-plus"></i> Adicionar Usuário
                            </button>
                        </div>
                        <ul id="users-list" class="flex flex-col gap-2"></ul>
                    </div>

                    <div class="card max-w-2xl mt-6">
                        <div class="flex justify-between items-center mb-4 border-b pb-4">
                            <h3 class="text-lg font-bold flex items-center gap-2"><i data-lucide="file-text" class="text-blue-600"></i> Configuração NF-e (Nota Fiscal Eletrônica)</h3>
                        </div>
                        <div class="flex flex-col gap-4">
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                                <div>
                                    <label class="font-medium">Ativar Emissão de NF-e</label>
                                    <p class="text-sm text-gray-500">Habilita a geração de notas fiscais no sistema</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="nfe-toggle" onchange="toggleNFe()">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            
                            <div id="nfe-config-fields" class="hidden space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="input-group">
                                        <label class="input-label">CNPJ da Empresa</label>
                                        <input type="text" id="nfe-cnpj" class="input" placeholder="00.000.000/0001-00">
                                    </div>
                                    <div class="input-group">
                                        <label class="input-label">Inscrição Estadual</label>
                                        <input type="text" id="nfe-ie" class="input" placeholder="000.000.000.000">
                                    </div>
                                </div>
                                
                                <div class="input-group">
                                    <label class="input-label">Razão Social</label>
                                    <input type="text" id="nfe-company-name" class="input" placeholder="Nome completo da empresa">
                                </div>
                                
                                <div class="input-group">
                                    <label class="input-label">Endereço Completo</label>
                                    <input type="text" id="nfe-address" class="input" placeholder="Rua, número, bairro, cidade - UF">
                                </div>
                                
                                <div class="grid grid-cols-3 gap-4">
                                    <div class="input-group">
                                        <label class="input-label">Série da NF-e</label>
                                        <input type="text" id="nfe-series" class="input" value="1" placeholder="1">
                                    </div>
                                    <div class="input-group">
                                        <label class="input-label">Número Inicial</label>
                                        <input type="number" id="nfe-start-number" class="input" value="1" placeholder="1">
                                    </div>
                                    <div class="input-group">
                                        <label class="input-label">Ambiente</label>
                                        <select id="nfe-environment" class="input">
                                            <option value="homologacao">Homologação</option>
                                            <option value="producao">Produção</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="flex gap-2">
                                    <button class="btn btn-primary" onclick="saveNFeConfig()">
                                        <i data-lucide="save"></i> Salvar Configurações
                                    </button>
                                    <button class="btn btn-secondary" onclick="previewNFe()">
                                        <i data-lucide="eye"></i> Visualizar Modelo
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card max-w-2xl mt-6">
                        <div class="flex justify-between items-center mb-4 border-b pb-4">
                            <h3 class="text-lg font-bold flex items-center gap-2"><i data-lucide="printer" class="text-gray-700"></i> Configuração de Recibo</h3>
                        </div>
                        <div class="flex flex-col gap-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="input-group">
                                    <label class="input-label">Largura (px)</label>
                                    <input type="number" id="receipt-width" class="input" min="200" max="600" placeholder="320">
                                </div>
                                <div class="input-group">
                                    <label class="input-label">Título</label>
                                    <input type="text" id="receipt-title" class="input" placeholder="CUPOM NÃO FISCAL">
                                </div>
                            </div>
                            <div class="input-group">
                                <label class="input-label">Nome do Estabelecimento</label>
                                <input type="text" id="receipt-company" class="input" placeholder="Flokite System">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Endereço</label>
                                <input type="text" id="receipt-address" class="input" placeholder="Rua Exemplo, 123 - Centro">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Rodapé</label>
                                <input type="text" id="receipt-footer" class="input" placeholder="Flokite System">
                            </div>
                            <div class="flex gap-4">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="receipt-show-header"> Mostrar cabeçalho
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="receipt-show-border"> Mostrar borda
                                </label>
                            </div>
                            <div class="flex gap-2">
                                <button class="btn btn-primary" onclick="saveReceiptConfig()"><i data-lucide=\"save\"></i> Salvar Recibo</button>
                                <button class="btn btn-secondary" onclick="previewReceiptConfig()"><i data-lucide=\"eye\"></i> Visualizar Recibo</button>
                            </div>
                        </div>
                    </div>

                    <div class="card max-w-2xl mt-6">
                        <div class="flex justify-between items-center mb-4 border-b pb-4">
                            <h3 class="text-lg font-bold flex items-center gap-2"><i data-lucide="database" class="text-indigo-600"></i> Backup de Dados</h3>
                        </div>
                        <div class="flex gap-2 items-center">
                            <button class="btn btn-primary" onclick="testBackup()"><i data-lucide="save"></i> Testar Backup</button>
                            <button class="btn btn-secondary" onclick="downloadLatestBackup()"><i data-lucide="download"></i> Baixar Último Backup</button>
                            <label class="btn btn-secondary">
                                <i data-lucide="upload"></i> Restaurar Backup
                                <input type="file" id="restore-backup-input" accept="application/json" style="display:none" onchange="restoreBackupFromFile(event)">
                            </label>
                        </div>
                    </div>
                    <div class="mt-8 pt-8 border-t">
                        <h3 class="text-lg font-bold text-red-600 mb-4">Zona de Perigo</h3>
                        <button class="btn btn-danger" onclick="resetSystem()">
                            <i data-lucide="refresh-cw"></i> Resetar Todos os Dados
                        </button>
                        <p class="text-sm text-gray-500 mt-2">Isso apagará todos os produtos e configurações e restaurará os dados de demonstração.</p>
                    </div>
                </div>

        </main>
    </div>

    <!-- MODAL DE PRODUTO -->
    <div id="product-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold" id="modal-title">Adicionar Produto</h2>
                <button onclick="closeProductModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form id="product-form">
                <input type="hidden" id="prod-id">
                <div class="input-group">
                    <label class="input-label">Nome do Produto</label>
                    <input type="text" id="prod-name" class="input" required placeholder="Ex: Coca Cola 2L">
                </div>
                <div class="input-group">
                    <label class="input-label">URL da Imagem (Opcional)</label>
                    <input type="url" id="prod-image" class="input" placeholder="https://exemplo.com/foto.jpg">
                    <p class="text-xs text-gray-500 mt-1">Deixe em branco para usar imagem padrão.</p>
                </div>
                <div class="input-group">
                    <label class="input-label">Categoria (Nicho)</label>
                    <select id="prod-category" class="input" required>
                        <option value="Outros">Selecione ou deixe Outros</option>
                        <option value="Bebidas">Bebidas</option>
                        <option value="Carnes">Carnes</option>
                        <option value="Alimentos">Alimentos</option>
                        <option value="Limpeza">Limpeza</option>
                        <option value="Higiene">Higiene</option>
                        <option value="Padaria">Padaria</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
                <div class="flex gap-4">
                    <div class="input-group w-full">
                        <label class="input-label">Preço (R$)</label>
                        <input type="number" id="prod-price" class="input" step="0.01" min="0" required placeholder="0.00">
                    </div>
                    <div class="input-group w-full">
                        <label class="input-label">Quantidade em Estoque</label>
                        <input type="number" id="prod-stock" class="input" min="0" required placeholder="0">
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Produto</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL DE PAGAMENTO -->
    <div id="payment-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Finalizar Venda</h2>
                <button onclick="closePaymentModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x"></i>
                </button>
            </div>
            
            <div class="mb-6 text-center">
                <p class="text-gray-500">Total a Pagar</p>
                <h2 class="text-3xl font-bold text-blue-600" id="pay-total">R$ 0,00</h2>
            </div>

            <div class="mb-4 flex items-center justify-between bg-gray-50 p-3 rounded border">
                <span class="font-medium text-gray-700">Dividir Pagamento (2 formas)</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="split-payment-toggle" class="sr-only peer" onchange="toggleSplitPayment()">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>

            <div class="mb-6">
                <label class="input-label mb-2">Selecione a(s) Forma(s) de Pagamento</label>
                <div class="grid-cols-2" id="payment-options">
                    <!-- JS Populates -->
                </div>
                <div id="pix-display-container"></div>
                <div id="fiado-customer-container"></div>
                <div id="cash-change-container"></div>
            </div>

            <div id="split-payment-values" class="hidden mb-6 p-4 bg-gray-50 rounded border">
                <h4 class="font-bold text-sm mb-3 text-gray-700">Valores por Forma de Pagamento</h4>
                <div class="flex gap-4">
                    <div class="w-1/2">
                        <label class="text-xs font-bold text-gray-500 mb-1 block" id="label-method-1">Método 1</label>
                        <input type="number" id="val-method-1" class="input" step="0.01" oninput="calculateSplit(1)">
                    </div>
                    <div class="w-1/2">
                        <label class="text-xs font-bold text-gray-500 mb-1 block" id="label-method-2">Método 2</label>
                        <input type="number" id="val-method-2" class="input" step="0.01" oninput="calculateSplit(2)">
                    </div>
                </div>
                <p id="split-validation-msg" class="text-xs mt-2 text-right font-bold"></p>
            </div>

            <button class="btn btn-success w-full py-3 text-lg" onclick="confirmPayment()">
                Confirmar Pagamento
            </button>
        </div>
    </div>

    <div id="pix-live-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Pagamento Pix</h2>
                <button onclick="closePixLiveModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div id="pix-live-qr" class="flex flex-col items-center gap-2"></div>
            <div id="pix-live-status" class="text-center text-sm text-gray-600 mt-4">Aguardando pagamento...</div>
            <div class="flex justify-end mt-6">
                <button class="btn btn-secondary" onclick="closePixLiveModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- MODAL PÓS-VENDA (RECIBO) -->
    <div id="post-sale-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div class="mb-6">
                <div class="mx-auto w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-4">
                    <i data-lucide="check" style="width: 32px; height: 32px;"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-800">Venda Realizada!</h2>
                <p class="text-gray-500 mt-1">O que deseja fazer com o recibo?</p>
            </div>
            
            <div class="flex flex-col gap-3">
                <button class="btn btn-primary w-full py-3 flex items-center justify-center gap-2" onclick="handlePrintReceipt()">
                    <i data-lucide="printer"></i> Imprimir Recibo
                </button>
                <button class="btn btn-secondary w-full py-3 flex items-center justify-center gap-2" onclick="handleViewReceipt()">
                    <i data-lucide="eye"></i> Visualizar na Tela
                </button>
                <button class="btn btn-secondary w-full py-2 text-gray-500 border-none hover:bg-gray-100 mt-2" onclick="closePostSaleModal()">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE EDIÇÃO DE VENDA -->
    <div id="sale-edit-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Editar Venda</h2>
                <button onclick="closeSaleEditModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <input type="hidden" id="edit-sale-id">
            <div class="mb-4">
                <p class="text-sm text-gray-500 mb-1">ID da Venda</p>
                <p class="font-bold" id="display-sale-id">#000</p>
            </div>
            <div class="input-group">
                <label class="input-label">Nova Forma de Pagamento</label>
                <input type="text" id="edit-sale-payment" class="input" placeholder="Ex: Dinheiro">
                <p class="text-xs text-gray-500 mt-1">Descreva a nova forma (ex: Pix, Dinheiro + Cartão)</p>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button type="button" class="btn btn-secondary" onclick="closeSaleEditModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveSaleEdit()">Salvar Alterações</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONTAS A PAGAR -->
    <div id="payable-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold" id="payable-modal-title">Conta a Pagar</h2>
                <button onclick="closePayableModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x"></i>
                </button>
            </div>
            
            <!-- Quick Select -->
            <div class="mb-4 p-3 bg-gray-50 rounded border">
                 <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">Preenchimento Rápido (Sugestões)</label>
                 <div class="flex gap-2 flex-wrap">
                     <button type="button" onclick="fillPayable('Energia Elétrica', 'Energia', 'https://cdn-icons-png.flaticon.com/512/2933/2933861.png')" class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs hover:bg-yellow-200 border border-yellow-200 flex items-center gap-1">⚡ Energia</button>
                     <button type="button" onclick="fillPayable('Conta de Água', 'Água', 'https://cdn-icons-png.flaticon.com/512/3105/3105807.png')" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs hover:bg-blue-200 border border-blue-200 flex items-center gap-1">💧 Água</button>
                     <button type="button" onclick="fillPayable('Internet / Telefone', 'Internet', 'https://cdn-icons-png.flaticon.com/512/2059/2059338.png')" class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-xs hover:bg-purple-200 border border-purple-200 flex items-center gap-1">🌐 Internet</button>
                     <button type="button" onclick="fillPayable('Aluguel', 'Aluguel', 'https://cdn-icons-png.flaticon.com/512/2558/2558072.png')" class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs hover:bg-green-200 border border-green-200 flex items-center gap-1">🏠 Aluguel</button>
                     <button type="button" onclick="fillPayable('Fornecedor', 'Fornecedores', 'https://cdn-icons-png.flaticon.com/512/2821/2821868.png')" class="px-3 py-1 bg-gray-100 text-gray-800 rounded-full text-xs hover:bg-gray-200 border border-gray-200 flex items-center gap-1">📦 Fornecedor</button>
                 </div>
            </div>

            <form id="payable-form">
                <input type="hidden" id="payable-id">
                <div class="input-group">
                    <label class="input-label">Nome da Conta</label>
                    <input type="text" id="payable-name" class="input" required placeholder="Ex: Conta de Luz">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                     <div class="input-group">
                        <label class="input-label">Categoria</label>
                        <select id="payable-category" class="input">
                            <!-- Populated via JS -->
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Vencimento</label>
                        <input type="date" id="payable-date" class="input" required>
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">Valor Total (R$)</label>
                    <input type="number" id="payable-total" class="input" required step="0.01" min="0">
                </div>

                <div class="input-group">
                    <label class="input-label">URL da Imagem (Opcional)</label>
                    <div class="flex gap-2">
                        <input type="url" id="payable-image" class="input flex-1" placeholder="https://...">
                        <img id="payable-preview" src="" class="w-10 h-10 rounded bg-gray-100 object-cover hidden">
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Se vazio, será usada uma imagem padrão baseada na categoria.</p>
                </div>

                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" class="btn btn-secondary" onclick="closePayableModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL DE PREVIEW NF-e -->
    <div id="nfe-preview-modal" class="modal-overlay hidden">
        <div class="modal-content max-w-4xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Preview da Nota Fiscal Eletrônica</h2>
                <button onclick="closeNFePreview()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x"></i>
                </button>
            </div>
            
            <div class="bg-white border-2 border-gray-300 rounded p-6 font-mono text-sm" style="font-size: 12px;">
                <div class="text-center border-b-2 border-gray-800 pb-4 mb-4">
                    <h3 class="text-lg font-bold">NOTA FISCAL ELETRÔNICA</h3>
                    <p class="text-xs">NF-e - SÉRIE <span id="preview-nfe-series">1</span> - Nº <span id="preview-nfe-number">000001</span></p>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <p class="font-bold mb-2">DADOS DO EMITENTE:</p>
                        <p id="preview-company-name">[Nome da Empresa]</p>
                        <p>CNPJ: <span id="preview-cnpj">00.000.000/0001-00</span></p>
                        <p>IE: <span id="preview-ie">000.000.000.000</span></p>
                        <p id="preview-address">[Endereço completo]</p>
                    </div>
                    <div>
                        <p class="font-bold mb-2">DADOS DA NOTA:</p>
                        <p>Data/Hora: <span id="preview-date">DD/MM/AAAA HH:MM:SS</span></p>
                        <p>Ambiente: <span id="preview-environment">HOMOLOGAÇÃO</span></p>
                        <p>Protocolo: <span id="preview-protocol">123456789012345</span></p>
                    </div>
                </div>
                
                <div class="border-t border-gray-300 pt-4 mb-4">
                    <p class="font-bold mb-2">DESTINATÁRIO:</p>
                    <p id="preview-customer">CONSUMIDOR FINAL</p>
                    <p>CPF/CNPJ: <span id="preview-customer-doc">000.000.000-00</span></p>
                </div>
                
                <div class="border-t border-gray-300 pt-4 mb-4">
                    <p class="font-bold mb-2">PRODUTOS/SERVIÇOS:</p>
                    <table class="w-full text-xs">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left">CÓD</th>
                                <th class="text-left">DESCRIÇÃO</th>
                                <th class="text-center">QTD</th>
                                <th class="text-right">VL UNIT</th>
                                <th class="text-right">VL TOTAL</th>
                            </tr>
                        </thead>
                        <tbody id="preview-products">
                            <tr>
                                <td>001</td>
                                <td>Produto Exemplo 1</td>
                                <td class="text-center">2</td>
                                <td class="text-right">R$ 10,00</td>
                                <td class="text-right">R$ 20,00</td>
                            </tr>
                            <tr>
                                <td>002</td>
                                <td>Produto Exemplo 2</td>
                                <td class="text-center">1</td>
                                <td class="text-right">R$ 15,00</td>
                                <td class="text-right">R$ 15,00</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="border-t border-gray-300 pt-4 mb-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="font-bold mb-2">CÁLCULO DO IMPOSTO:</p>
                            <p>Base ICMS: R$ 35,00</p>
                            <p>Valor ICMS: R$ 6,30</p>
                            <p>Base ICMS ST: R$ 0,00</p>
                            <p>Valor ICMS ST: R$ 0,00</p>
                        </div>
                        <div>
                            <p class="font-bold mb-2">TOTAIS:</p>
                            <p>Total Produtos: R$ 35,00</p>
                            <p>Desconto: R$ 0,00</p>
                            <p>Total NF-e: R$ 35,00</p>
                            <p class="font-bold">Valor a Pagar: R$ 35,00</p>
                        </div>
                    </div>
                </div>
                
                <div class="border-t border-gray-300 pt-4 text-center">
                    <p class="text-xs text-gray-600">Consulta de autenticidade no portal nacional da NF-e www.nfe.fazenda.gov.br</p>
                    <p class="text-xs text-gray-600">ou no site da Sefaz Autorizada</p>
                </div>
            </div>
            
            <div class="flex justify-end gap-2 mt-6">
                <button class="btn btn-secondary" onclick="closeNFePreview()">Fechar</button>
                <button class="btn btn-primary" onclick="generateNFe()">
                    <i data-lucide="file-text"></i> Gerar NF-e
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE CLIENTE (FIADO) -->
    <div id="customer-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold" id="customer-modal-title">Adicionar Cliente</h2>
                <button onclick="closeCustomerModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <input type="hidden" id="customer-modal-id">
            <div class="grid-cols-2">
                <div class="input-group">
                    <label class="input-label">Nome</label>
                    <input type="text" id="cust-modal-name" class="input" placeholder="Nome completo">
                </div>
                <div class="input-group">
                    <label class="input-label">Telefone</label>
                    <input type="text" id="cust-modal-phone" class="input" placeholder="(00) 00000-0000">
                </div>
                <div class="input-group">
                    <label class="input-label">Email</label>
                    <input type="email" id="cust-modal-email" class="input" placeholder="email@exemplo.com">
                </div>
                <div class="input-group">
                    <label class="input-label">Foto (imagem)</label>
                    <input type="file" id="cust-modal-photo-input" class="input" accept="image/*">
                    <div id="cust-modal-photo-preview" class="mt-2"></div>
                </div>
                <div class="input-group">
                    <label class="input-label">Limite de Crédito (R$)</label>
                    <input type="number" id="cust-modal-credit-limit" class="input" placeholder="0 = sem limite" min="0" step="0.01" value="0">
                    <p class="text-xs text-gray-500 mt-1">Deixe 0 para não limitar o fiado deste cliente.</p>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button type="button" class="btn btn-secondary" onclick="closeCustomerModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveCustomer()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE USUÁRIO -->
    <div id="user-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold" id="user-modal-title">Adicionar Usuário</h2>
                <button onclick="closeUserModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <input type="hidden" id="user-modal-id">
            <div class="grid-cols-2">
                <div class="input-group">
                    <label class="input-label">Nome</label>
                    <input type="text" id="user-name" class="input" placeholder="Nome completo">
                </div>
                <div class="input-group">
                    <label class="input-label">Email</label>
                    <input type="email" id="user-email" class="input" placeholder="email@exemplo.com">
                </div>
                <div class="input-group">
                    <label class="input-label">Senha</label>
                    <input type="password" id="user-password" class="input" placeholder="*******">
                </div>
                <div class="input-group">
                    <label class="input-label">Perfil</label>
                    <select id="user-role" class="input">
                        <option value="admin">Admin</option>
                        <option value="caixa" selected>Caixa</option>
                    </select>
                </div>
                <div class="input-group">
                    <label class="input-label">Foto (imagem)</label>
                    <input type="file" id="user-photo-input" class="input" accept="image/*">
                    <div id="user-photo-preview" class="mt-2"></div>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button type="button" class="btn btn-secondary" onclick="closeUserModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveUserForm()">Salvar</button>
            </div>
        </div>
    </div>

    <script>
        // SweetAlert2: toasts e confirmações (substitui alert/confirm)
        function toast(msg, type = 'success') {
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: type,
                title: msg,
                showConfirmButton: false,
                timer: 3200,
                timerProgressBar: true,
                background: 'var(--bg-gray, #f3f4f6)',
                color: 'var(--text-dark, #1f2937)'
            });
        }
        function toastSuccess(msg) { toast(msg, 'success'); }
        function toastError(msg) { toast(msg, 'error'); }
        function toastInfo(msg) { toast(msg, 'info'); }
        function toastWarning(msg) { toast(msg, 'warning'); }
        function confirmDialog(title, text = '', options = {}) {
            return Swal.fire({
                title: title,
                text: text,
                icon: options.icon || 'question',
                showCancelButton: true,
                confirmButtonText: options.confirmText || 'Sim',
                cancelButtonText: options.cancelText || 'Cancelar',
                confirmButtonColor: options.danger ? '#ef4444' : '#2563eb',
                ...options
            }).then(r => r.isConfirmed);
        }

        // State Keys
        const STORAGE_KEY_PRODUCTS = 'pdv_products_data';
        const STORAGE_KEY_PAYMENT = 'pdv_payment_methods';
        const STORAGE_KEY_CATEGORIES = 'pdv_categories';
        const STORAGE_KEY_SALES = 'pdv_sales_history';
        const STORAGE_KEY_PIX = 'pdv_pix_config';
        const STORAGE_KEY_CUSTOMERS = 'pdv_customers';
        const STORAGE_KEY_PAYABLES = 'pdv_payables';
        const STORAGE_KEY_PAYABLE_CATEGORIES = 'pdv_payable_categories';
        const STORAGE_KEY_NFE = 'pdv_nfe_config';
        const STORAGE_KEY_USERS = 'pdv_users';
        const STORAGE_KEY_INTEGRATIONS = 'pdv_integrations';
        const STORAGE_KEY_RECEIPT = 'pdv_receipt_config';
        
        // Initial Data
        const initialCategories = ['Bebidas', 'Carnes', 'Alimentos', 'Limpeza', 'Higiene', 'Padaria', 'Outros'];

        const initialProducts = [
            { id: 1, name: 'Refrigerante Cola 350ml', price: 5.50, stock: 100, image: 'https://images.unsplash.com/photo-1622483767028-3f66f32aef97?w=500&auto=format&fit=crop&q=60', category: 'Bebidas' },
            { id: 2, name: 'Salgado Coxinha', price: 6.00, stock: 50, image: 'https://images.unsplash.com/photo-1541592103048-4e7c014badfc?w=500&auto=format&fit=crop&q=60', category: 'Alimentos' },
            { id: 3, name: 'Água Mineral 500ml', price: 3.00, stock: 200, image: 'https://images.unsplash.com/photo-1548839140-29a749e1cf4d?w=500&auto=format&fit=crop&q=60', category: 'Bebidas' },
            { id: 4, name: 'Hambúrguer Clássico', price: 18.90, stock: 20, image: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=500&auto=format&fit=crop&q=60', category: 'Alimentos' },
            { id: 5, name: 'Batata Frita', price: 12.00, stock: 30, image: 'https://images.unsplash.com/photo-1573080496987-a199f8cd4054?w=500&auto=format&fit=crop&q=60', category: 'Alimentos' },
        ];

        const initialPayments = ['Dinheiro', 'Cartão de Crédito', 'Cartão de Débito', 'Pix', 'Fiado', 'Stripe', 'Mercado Pago'];

        // State Variables
        let products = [];
        let paymentMethods = [];
        let users = [];
        let integrations = { stripeLink: '', mpLink: '' };
        let currentUser = null;
        let categories = [];
        let cart = [];
        let sales = [];
        let pixConfig = { key: '', name: '' };
        let receiptConfig = { width: 320, companyName: 'Flokite System', addressLine: 'Rua Exemplo, 123 - Centro', title: 'CUPOM NÃO FISCAL', footerText: 'Flokite System', showHeader: true, showBorder: true };
        let customers = [];
        let currentCustomerId = null;
        let payables = [];
        let payableCategories = [];
        let currentPayableId = null;
        let currentPixTxid = null;
        let pixPollInterval = null;
        let pendingSaleData = null;
        


        // --- API (persistência no servidor / banco de dados) ---
        function getApiBase() { return window.location.origin; }

        function applyLoadedState(data) {
            if (data.products && Array.isArray(data.products)) products = data.products;
            if (data.categories && Array.isArray(data.categories)) categories = data.categories;
            if (data.paymentMethods && Array.isArray(data.paymentMethods)) paymentMethods = data.paymentMethods;
            if (data.users && Array.isArray(data.users)) users = data.users;
            if (data.integrations && typeof data.integrations === 'object') integrations = data.integrations;
            if (data.sales && Array.isArray(data.sales)) sales = data.sales;
            if (data.pixConfig && typeof data.pixConfig === 'object') pixConfig = data.pixConfig;
            if (data.customers && Array.isArray(data.customers)) customers = data.customers;
            if (data.payables && Array.isArray(data.payables)) payables = data.payables;
            if (data.payableCategories && Array.isArray(data.payableCategories)) payableCategories = data.payableCategories;
            if (data.receiptConfig && typeof data.receiptConfig === 'object') receiptConfig = data.receiptConfig;
            if (data.nfeConfig && typeof data.nfeConfig === 'object') {
                try { localStorage.setItem(STORAGE_KEY_NFE, JSON.stringify(data.nfeConfig)); } catch (e) {}
            }
            if (!users || users.length === 0) users = [{ id: 1, name: 'Administrador', email: 'admin@pdv.com', password: '123456', role: 'admin' }];
            if (!integrations || typeof integrations !== 'object') integrations = { stripeLink: '', mpLink: '' };
            if (!payableCategories || payableCategories.length === 0) payableCategories = [...categories];
        }

        function syncToLocalStorage() {
            localStorage.setItem(STORAGE_KEY_PRODUCTS, JSON.stringify(products));
            localStorage.setItem(STORAGE_KEY_PAYMENT, JSON.stringify(paymentMethods));
            localStorage.setItem(STORAGE_KEY_CATEGORIES, JSON.stringify(categories));
            localStorage.setItem(STORAGE_KEY_USERS, JSON.stringify(users));
            localStorage.setItem(STORAGE_KEY_INTEGRATIONS, JSON.stringify(integrations));
            localStorage.setItem(STORAGE_KEY_SALES, JSON.stringify(sales));
            localStorage.setItem(STORAGE_KEY_PIX, JSON.stringify(pixConfig));
            localStorage.setItem(STORAGE_KEY_CUSTOMERS, JSON.stringify(customers));
            localStorage.setItem(STORAGE_KEY_PAYABLES, JSON.stringify(payables));
            localStorage.setItem(STORAGE_KEY_PAYABLE_CATEGORIES, JSON.stringify(payableCategories));
            localStorage.setItem(STORAGE_KEY_RECEIPT, JSON.stringify(receiptConfig));
        }

        // --- LOADERS ---
        function loadData() {
            console.log('Connecting to Firestore Real-time Sync...');
            
            // Show loading state
            const dashboard = document.getElementById('page-home');
            if(dashboard) dashboard.innerHTML += '<div id="fs-loading" class="text-center p-4">Sincronizando dados...</div>';

            FirestoreService.listenProducts((data) => {
                products = data;
                renderProductsTable();
                renderPosGrid();
                updateDashboard();
                const loader = document.getElementById('fs-loading');
                if(loader) loader.remove();
            });

            FirestoreService.listenSales((data) => {
                sales = data;
                // renderSalesHistory() might not exist globally or needs period
                if (typeof filterSales === 'function') filterSales('day'); 
                updateDashboard();
            });

            FirestoreService.listenCustomers((data) => {
                customers = data;
                if (typeof renderCustomers === 'function') renderCustomers();
            });

            // Handle other data types if migrated
        
            const storedPayables = localStorage.getItem(STORAGE_KEY_PAYABLES);
            payables = storedPayables ? JSON.parse(storedPayables) : [];
            const storedPayableCats = localStorage.getItem(STORAGE_KEY_PAYABLE_CATEGORIES);
            payableCategories = storedPayableCats ? JSON.parse(storedPayableCats) : [...categories];
            const storedReceipt = localStorage.getItem(STORAGE_KEY_RECEIPT);
            receiptConfig = storedReceipt ? JSON.parse(storedReceipt) : receiptConfig;
            const storedCounterCart = localStorage.getItem('pdv_counter_cart');
            if (storedCounterCart) cart = JSON.parse(storedCounterCart);
        }

        function getFullState() {
            const nfeConfig = {};
            try {
                const s = localStorage.getItem(STORAGE_KEY_NFE);
                if (s) Object.assign(nfeConfig, JSON.parse(s));
            } catch (e) {}
            return {
                products,
                paymentMethods,
                categories,
                sales,
                customers,
                payables,
                payableCategories,
                users,
                integrations,
                receiptConfig,
                pixConfig,
                nfeConfig
            };
        }

        function syncToServer() {
            fetch(getApiBase() + '/api/db', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(getFullState())
            }).catch(() => {});
        }

        function saveData() {
            localStorage.setItem('pdv_counter_cart', JSON.stringify(cart));
            localStorage.setItem(STORAGE_KEY_PRODUCTS, JSON.stringify(products));
            localStorage.setItem(STORAGE_KEY_PAYMENT, JSON.stringify(paymentMethods));
            localStorage.setItem(STORAGE_KEY_CATEGORIES, JSON.stringify(categories));
            localStorage.setItem(STORAGE_KEY_SALES, JSON.stringify(sales));
            localStorage.setItem(STORAGE_KEY_CUSTOMERS, JSON.stringify(customers));
            localStorage.setItem(STORAGE_KEY_PAYABLES, JSON.stringify(payables));
            localStorage.setItem(STORAGE_KEY_PAYABLE_CATEGORIES, JSON.stringify(payableCategories));
            updateDashboard();
            try { updateNotifications(); } catch(e) {}
            syncToServer();
        }

        // --- CLOUD SYNC & PWA ---
        // Configuração do Firebase (Coloque suas chaves aqui futuramente)
        const firebaseConfig = {
            // apiKey: "...",
            // authDomain: "...",
            // projectId: "...",
        };

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(() => console.log('Service Worker registrado'))
                .catch(err => console.error('Erro SW:', err));
        }

        // --- AUTHENTICATION ---
        AuthService.init((user) => {
            if (user) {
                currentUser = { id: user.uid, name: user.displayName || user.email, email: user.email, role: 'admin' };
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard-screen').classList.remove('hidden');
                const userLabel = document.querySelector('.font-medium.text-sm');
                if (userLabel) userLabel.innerText = currentUser.name || 'Usuário';
                updateDashboard();
                if (typeof loadData === 'function') loadData();
            } else {
                currentUser = null;
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('dashboard-screen').classList.add('hidden');
            }
        });

        function switchAuthTab(tab) {
            const loginForm = document.getElementById('login-form');
            const regForm = document.getElementById('register-form');
            const tabLogin = document.getElementById('tab-login');
            const tabReg = document.getElementById('tab-register');

            if (tab === 'login') {
                loginForm.classList.remove('hidden');
                regForm.classList.add('hidden');
                tabLogin.className = 'flex-1 py-2 text-center border-b-2 border-blue-500 font-bold text-blue-600';
                tabReg.className = 'flex-1 py-2 text-center border-b-2 border-transparent text-gray-500';
            } else {
                loginForm.classList.add('hidden');
                regForm.classList.remove('hidden');
                tabLogin.className = 'flex-1 py-2 text-center border-b-2 border-transparent text-gray-500';
                tabReg.className = 'flex-1 py-2 text-center border-b-2 border-blue-500 font-bold text-blue-600';
            }
        }

        function openForgotPasswordModal() {
            document.getElementById('forgot-password-modal').classList.remove('hidden');
        }

        function closeForgotPasswordModal() {
            document.getElementById('forgot-password-modal').classList.add('hidden');
        }

        async function handleGoogleLogin() {
            const res = await AuthService.loginWithGoogle();
            if (res.success) {
                toastSuccess('Login realizado com Google!');
            } else {
                toastError(res.error);
            }
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const res = await AuthService.login(email, pass);
            if (res.success) {
                toastSuccess('Login realizado!');
            } else {
                toastError(res.error);
            }
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-password').value;
            const confirm = document.getElementById('reg-confirm-password').value;

            if (pass !== confirm) {
                toastError('As senhas não coincidem!');
                return;
            }

            const res = await AuthService.register(email, pass);
            if (res.success) {
                toastSuccess('Cadastro realizado! Bem-vindo.');
            } else {
                toastError(res.error);
            }
        });

        document.getElementById('forgot-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('forgot-email').value;
            const res = await AuthService.resetPassword(email);
            if (res.success) {
                toastSuccess('Email de recuperação enviado!');
                closeForgotPasswordModal();
            } else {
                toastError(res.error);
            }
        });

        // --- NAVIGATION ---
        function setActiveNav(page) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const ids = [];
            ids.push(`nav-${page}`, `mob-nav-${page}`);
            if (page === 'products') ids.push('nav-produtos', 'nav-estoque', 'mob-nav-produtos', 'mob-nav-estoque');
            if (page === 'fiado') ids.push('nav-clientes', 'nav-crediario', 'mob-nav-clientes', 'mob-nav-crediario');
            ids.forEach(id => { const el = document.getElementById(id); if (el) el.classList.add('active'); });
        }
        function navigate(page) {
            ['home', 'products', 'pos', 'settings', 'sales', 'fiado', 'apagar'].forEach(p => {
                const pg = document.getElementById(`page-${p}`);
                if (pg) pg.classList.add('hidden');
            });
            const target = document.getElementById(`page-${page}`);
            if (target) target.classList.remove('hidden');
            setActiveNav(page);
            closeMobileNav();
            updateNotifications();
            if(page === 'products') renderProductsTable();
            if(page === 'pos') {
                renderPosGrid();
            }
            if(page === 'settings') renderSettings();
            if(page === 'sales') filterSales('day');
            if(page === 'home') updateDashboard();
            if(page === 'fiado') renderFiadoPage();
            if(page === 'apagar') renderApagarPage();
            if(page === 'reports') renderReportsPage();
            
            const titles = { 
                'home': 'Resumo', 'products': 'Produtos', 'pos': 'Caixa', 'settings': 'Configurações', 
                'sales': 'Vendas', 'fiado': 'Clientes', 'apagar': 'Contas a Pagar', 'reports': 'Relatórios'
            };
            const titleEl = document.getElementById('page-title');
            if (titleEl) titleEl.innerText = titles[page] || 'PDV';
        }

        function toggleNotifications() {
            const dropdown = document.getElementById('notif-dropdown');
            dropdown.classList.toggle('hidden');
        }

        function markAllRead() {
            // In a real app, this would update read status
            toggleNotifications();
        }

        function updateNotifications() {
            const list = document.getElementById('notif-list');
            const badge = document.getElementById('notif-badge');
            list.innerHTML = '';
            
            let count = 0;
            
            // Low Stock
            const lowStock = products.filter(p => p.stock <= 5);
            lowStock.forEach(p => {
                count++;
                const item = document.createElement('div');
                item.className = 'p-3 border-b hover:bg-gray-50';
                item.innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="text-red-500"><i data-lucide="alert-circle" width="16"></i></div>
                        <div>
                            <p class="text-sm font-bold text-gray-800">Estoque Baixo</p>
                            <p class="text-xs text-gray-600">Produto <strong>${p.name}</strong> está prestes a acabar ( ${p.stock} un ).</p>
                        </div>
                    </div>
                `;
                list.appendChild(item);
            });

            // Due Payments
            const now = new Date();
            const dueSoon = (payables || []).filter(p => {
                const paid = (p.ledger || []).filter(l => l.type === 'payment').reduce((acc, l) => acc + l.amount, 0);
                const remaining = p.total - paid;
                if (remaining <= 0) return false;
                const due = new Date(p.dueDate);
                const diff = (due - now) / (1000 * 60 * 60 * 24);
                return diff <= 3; // 3 days notice
            });

            dueSoon.forEach(p => {
                count++;
                const item = document.createElement('div');
                item.className = 'p-3 border-b hover:bg-gray-50';
                item.innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="text-orange-500"><i data-lucide="clock" width="16"></i></div>
                        <div>
                            <p class="text-sm font-bold text-gray-800">Conta a Vencer</p>
                            <p class="text-xs text-gray-600"><strong>${p.name}</strong> vence em breve.</p>
                        </div>
                    </div>
                `;
                list.appendChild(item);
            });

            if (count === 0) {
                list.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">Nenhuma notificação nova.</div>';
                badge.classList.add('hidden');
            } else {
                badge.innerText = count;
                badge.classList.remove('hidden');
            }
            lucide.createIcons();
        }

        // Call updateNotifications periodically or on load
        setInterval(updateNotifications, 30000); // Every 30s

        let isCompact = localStorage.getItem('pdv_compact') === '1';
        function applyCompact() {
            const root = document.querySelector('main').parentElement;
            const dash = document.getElementById('dashboard-screen');
            if (isCompact) {
                root.classList.add('compact');
                dash.classList.add('sidebar-hidden');
            } else {
                root.classList.remove('compact');
                dash.classList.remove('sidebar-hidden');
            }
        }
        applyCompact();

        // Modo escuro (reduz cansaço visual em uso prolongado)
        const DARK_STORAGE_KEY = 'pdv_dark_theme';
        function isDarkMode() { return localStorage.getItem(DARK_STORAGE_KEY) === '1'; }
        function applyDarkMode() {
            const dark = isDarkMode();
            document.documentElement.setAttribute('data-theme', dark ? 'dark' : 'light');
            const metaTheme = document.querySelector('meta[name="theme-color"]');
            if (metaTheme) metaTheme.setAttribute('content', dark ? '#111827' : '#2563eb');
            const iconMoon = document.getElementById('dark-mode-icon-moon');
            const iconSun = document.getElementById('dark-mode-icon-sun');
            if (iconMoon && iconSun) {
                iconMoon.classList.toggle('hidden', dark);
                iconSun.classList.toggle('hidden', !dark);
            }
            const loginMoon = document.getElementById('login-icon-moon');
            const loginSun = document.getElementById('login-icon-sun');
            if (loginMoon && loginSun) {
                loginMoon.classList.toggle('hidden', dark);
                loginSun.classList.toggle('hidden', !dark);
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
        function toggleDarkMode() {
            localStorage.setItem(DARK_STORAGE_KEY, isDarkMode() ? '0' : '1');
            applyDarkMode();
        }
        applyDarkMode();

        function toggleCompact() {
            isCompact = !isCompact;
            localStorage.setItem('pdv_compact', isCompact ? '1' : '0');
            applyCompact();
        }

        function toggleSidebar() {
            const dash = document.getElementById('dashboard-screen');
            dash.classList.toggle('sidebar-hidden');
        }
        function handleMenuButton() {
            if (window.innerWidth <= 768) {
                openMobileNav();
            } else {
                toggleSidebar();
            }
        }
        function openMobileNav() {
            const el = document.getElementById('mobile-nav');
            el.classList.remove('hidden');
            el.classList.add('open');
            lucide.createIcons();
        }
        function closeMobileNav() {
            const el = document.getElementById('mobile-nav');
            el.classList.remove('open');
            el.classList.add('hidden');
        }

        async function logout() {
            await AuthService.logout();
            cart = []; // Clear cart on logout
        }

        // --- REPORTS PAGE ---
        let chartCashflow = null;
        let chartPaymentMethods = null;

        function renderReportsPage() {
            // Calculate Income (Sales)
            const income = sales.reduce((acc, s) => acc + s.total, 0);
            
            // Calculate Expenses (Paid Payables)
            let expenses = 0;
            if (payables) {
                payables.forEach(p => {
                    expenses += (p.ledger || []).filter(l => l.type === 'payment').reduce((acc, l) => acc + l.amount, 0);
                });
            }

            document.getElementById('rep-income').innerText = formatCurrency(income);
            document.getElementById('rep-expenses').innerText = formatCurrency(expenses);
            document.getElementById('rep-balance').innerText = formatCurrency(income - expenses);

            // Charts
            if (typeof Chart === 'undefined') return;

            // Cashflow Chart
            const ctxCf = document.getElementById('chart-cashflow');
            if (ctxCf) {
                if (chartCashflow) chartCashflow.destroy();
                chartCashflow = new Chart(ctxCf, {
                    type: 'doughnut',
                    data: {
                        labels: ['Entradas', 'Saídas'],
                        datasets: [{
                            data: [income, expenses],
                            backgroundColor: ['#16a34a', '#dc2626']
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
                });
            }

            // Payment Methods Chart
            const methods = {};
            sales.forEach(s => {
                const method = s.paymentMethod.split('(')[0].trim(); // Simple split for "Dinheiro (R$ 10)"
                methods[method] = (methods[method] || 0) + 1;
            });
            
            const ctxPm = document.getElementById('chart-payment-methods');
            if (ctxPm) {
                if (chartPaymentMethods) chartPaymentMethods.destroy();
                chartPaymentMethods = new Chart(ctxPm, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(methods),
                        datasets: [{
                            data: Object.values(methods),
                            backgroundColor: ['#2563eb', '#9333ea', '#f59e0b', '#10b981', '#6366f1']
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
                });
            }
        }

        // --- DASHBOARD ---
        function updateDashboard() {
            const now = new Date();
            
            // 1. Update Date/Time
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateStr = now.toLocaleDateString('pt-BR', dateOptions);
            const timeStr = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            const dateTimeEl = document.getElementById('current-datetime');
            if (dateTimeEl) {
                // Capitalize first letter
                const formattedDate = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
                dateTimeEl.innerHTML = `${formattedDate} <span class="mx-2">•</span> ${timeStr}`;
            }

            // 2. Sales Today
            const todaySales = (sales || []).filter(s => {
                const d = new Date(s.date);
                return d.getDate() === now.getDate() && 
                       d.getMonth() === now.getMonth() && 
                       d.getFullYear() === now.getFullYear();
            });
            const todayTotal = todaySales.reduce((acc, s) => acc + s.total, 0);
            const salesTodayEl = document.getElementById('home-sales-total');
            if (salesTodayEl) salesTodayEl.innerText = formatCurrency(todayTotal);

            // 3. Totais em Caixa (Using Month Income as proxy)
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const monthIncome = (sales || []).filter(s => {
                const d = new Date(s.date);
                return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            }).reduce((acc, s) => acc + s.total, 0);
            
            const cashTotalEl = document.getElementById('home-cash-total');
            if (cashTotalEl) cashTotalEl.innerText = formatCurrency(monthIncome);

            // 4. Alerts List
            const alertsListEl = document.getElementById('home-alerts-list');
            if (alertsListEl) {
                alertsListEl.innerHTML = '';
                let hasAlerts = false;

                // Low Stock Alert
                const lowStockCount = (products || []).filter(p => p.stock <= 5).length;
                if (lowStockCount > 0) {
                    hasAlerts = true;
                    const alertItem = document.createElement('div');
                    alertItem.className = 'flex items-center justify-between p-3 bg-red-50 rounded-lg border border-red-100 mb-2';
                    alertItem.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-red-100 text-red-600 rounded-full">
                                <i data-lucide="alert-circle" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <p class="font-medium text-gray-800">Estoque Baixo</p>
                                <p class="text-sm text-gray-500">${lowStockCount} produtos precisam de reposição</p>
                            </div>
                        </div>
                        <button onclick="navigate('stock')" class="text-sm text-blue-600 font-medium hover:underline">Ver</button>
                    `;
                    alertsListEl.appendChild(alertItem);
                }

                // Payables Alert
                const remaining = (p) => Math.max(0, p.total - (typeof sumPaid === 'function' ? sumPaid(p) : 0));
                const overdueOrDueSoon = (payables || []).filter(p => {
                    const rem = remaining(p);
                    if (rem <= 0) return false;
                    const due = new Date(p.dueDate);
                    const days = (due - now) / (1000 * 60 * 60 * 24);
                    return days < 0 || days <= 3; // 3 days warning
                });
                
                if (overdueOrDueSoon.length > 0) {
                    hasAlerts = true;
                    const alertItem = document.createElement('div');
                    alertItem.className = 'flex items-center justify-between p-3 bg-orange-50 rounded-lg border border-orange-100 mb-2';
                    alertItem.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-orange-100 text-orange-600 rounded-full">
                                <i data-lucide="clock" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <p class="font-medium text-gray-800">Contas a Pagar</p>
                                <p class="text-sm text-gray-500">${overdueOrDueSoon.length} contas vencendo ou vencidas</p>
                            </div>
                        </div>
                        <button onclick="navigate('financial')" class="text-sm text-blue-600 font-medium hover:underline">Ver</button>
                    `;
                    alertsListEl.appendChild(alertItem);
                }

                if (!hasAlerts) {
                    alertsListEl.innerHTML = `
                        <div class="text-center py-6 text-gray-400">
                            <i data-lucide="check-circle" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                            <p>Tudo certo! Sem alertas no momento.</p>
                        </div>
                    `;
                }
                
                // Re-initialize Lucide icons for new elements
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
            
            // Render Charts if elements exist (kept for compatibility)
            renderCharts();
        }

        let chartWeek = null;
        let chartMonth = null;

        function renderCharts() {
            if (typeof Chart === 'undefined') return;

            // Data Processing
            const weekDays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            const monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            
            const salesByWeek = [0,0,0,0,0,0,0];
            const salesByMonth = [0,0,0,0,0,0,0,0,0,0,0,0];

            sales.forEach(s => {
                const d = new Date(s.date);
                salesByWeek[d.getDay()] += s.total;
                salesByMonth[d.getMonth()] += s.total;
            });

            // Week Chart
            const ctxWeek = document.getElementById('chart-week');
            if (ctxWeek) {
                if (chartWeek) chartWeek.destroy();
                chartWeek = new Chart(ctxWeek, {
                    type: 'bar',
                    data: {
                        labels: weekDays,
                        datasets: [{
                            label: 'Vendas (R$)',
                            data: salesByWeek,
                            backgroundColor: '#2563eb',
                            borderRadius: 4
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { display: false } } }
                });
            }

            // Month Chart
            const ctxMonth = document.getElementById('chart-month');
            if (ctxMonth) {
                if (chartMonth) chartMonth.destroy();
                chartMonth = new Chart(ctxMonth, {
                    type: 'line',
                    data: {
                        labels: monthNames,
                        datasets: [{
                            label: 'Vendas (R$)',
                            data: salesByMonth,
                            borderColor: '#16a34a',
                            backgroundColor: 'rgba(22, 163, 74, 0.1)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { display: false } } }
                });
            }
        }

        function openMonthDetails() {
            const modal = document.getElementById('month-details-modal');
            const content = document.getElementById('month-details-content');
            const now = new Date();
            const m = now.getMonth();
            const y = now.getFullYear();
            const monthSales = (sales || []).filter(s => {
                const d = new Date(s.date);
                return d.getMonth() === m && d.getFullYear() === y;
            });
            const totalMonth = monthSales.reduce((acc, s) => acc + s.total, 0);
            const weeks = {};
            const days = {};
            monthSales.forEach(s => {
                const d = new Date(s.date);
                const w = Math.floor((d.getDate() - 1) / 7) + 1; // semanas 1..5
                weeks[w] = (weeks[w] || 0) + s.total;
                const day = d.getDate();
                days[day] = (days[day] || 0) + s.total;
            });
            const weekEntries = Object.entries(weeks).sort((a,b) => a[0]-b[0]);
            const dayEntries = Object.entries(days).sort((a,b) => a[0]-b[0]);
            let html = `
                <div class="grid-cols-2">
                    <div class="card">
                        <div class="text-sm text-gray-500">Total do Mês</div>
                        <div class="font-bold text-blue-700">${formatCurrency(totalMonth)}</div>
                    </div>
                    <div class="card">
                        <div class="text-sm text-gray-500">Dias com Venda</div>
                        <div class="font-bold">${dayEntries.length}</div>
                    </div>
                </div>
                <div class="mt-4 grid-cols-2">
                    <div class="card">
                        <h4 class="font-bold mb-2">Por Semana</h4>
                        <div>`;
            if (weekEntries.length === 0) {
                html += `<p class="text-sm text-gray-500">Sem vendas registradas neste mês.</p>`;
            } else {
                weekEntries.forEach(([w, val]) => {
                    html += `
                        <div class="ledger-entry">
                            <div class="text-sm text-gray-600">Semana ${w}</div>
                            <div class="font-bold text-green-700">${formatCurrency(val)}</div>
                        </div>`;
                });
            }
            html += `   </div>
                    </div>
                    <div class="card">
                        <h4 class="font-bold mb-2">Por Dia</h4>
                        <div>`;
            if (dayEntries.length === 0) {
                html += `<p class="text-sm text-gray-500">Sem vendas registradas neste mês.</p>`;
            } else {
                dayEntries.forEach(([d, val]) => {
                    html += `
                        <div class="ledger-entry">
                            <div class="text-sm text-gray-600">Dia ${d}</div>
                            <div class="font-bold text-blue-700">${formatCurrency(val)}</div>
                        </div>`;
                });
            }
            html += `   </div>
                    </div>
                </div>
            `;
            content.innerHTML = html;
            modal.classList.remove('hidden');
            lucide.createIcons();
        }
        function closeMonthDetails() {
            document.getElementById('month-details-modal').classList.add('hidden');
        }
        // --- PRODUCTS CRUD ---
        function renderProductsTable() {
            const tbody = document.getElementById('products-table-body');
            const emptyState = document.getElementById('empty-state');
            const tableEl = document.getElementById('products-table');
            const cardList = document.getElementById('products-card-list');
            
            if (tbody) tbody.innerHTML = '';
            if (cardList) cardList.innerHTML = '';

            if (!products || products.length === 0) {
                if (emptyState) emptyState.classList.remove('hidden');
                if (tableEl) tableEl.classList.add('hidden');
                if (cardList) cardList.classList.add('hidden');
                return;
            }
            if (emptyState) emptyState.classList.add('hidden');
            
            const isMobile = window.innerWidth <= 768;
            if (isMobile && cardList) {
                if (tableEl) tableEl.classList.add('hidden');
                cardList.classList.remove('hidden');
                products.forEach(p => {
                    const imgUrl = p.image || 'https://via.placeholder.com/80?text=Prod';
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-3 bg-white p-3 rounded border';
                    div.innerHTML = `
                        <img src="${imgUrl}" class="rounded bg-gray-100" style="width: 60px; height: 60px; object-fit: cover;">
                        <div class="flex-1">
                            <div class="font-bold text-gray-900">${p.name}</div>
                            <div class="text-sm text-gray-600">Preço: ${formatCurrency(p.price)}</div>
                            <div class="${p.stock < 10 ? 'text-red-600 font-bold' : 'text-gray-600'}">Estoque: ${p.stock} un</div>
                            <div class="text-gray-500">Total: ${formatCurrency(p.price * p.stock)}</div>
                        </div>
                        <div class="flex gap-2">
                            <button class="btn btn-secondary btn-sm" onclick="editProduct('${p.id}')"><i data-lucide="edit-2" style="width: 14px;"></i></button>
                            <button class="btn btn-danger btn-sm" onclick="deleteProduct('${p.id}')"><i data-lucide="trash-2" style="width: 14px;"></i></button>
                        </div>
                    `;
                    cardList.appendChild(div);
                });
            } else {
                if (tableEl) tableEl.classList.remove('hidden');
                if (cardList) cardList.classList.add('hidden');
                products.forEach(p => {
                    const tr = document.createElement('tr');
                    const imgUrl = p.image || 'https://via.placeholder.com/40?text=Prod';
                    tr.innerHTML = `
                        <td><img src="${imgUrl}" class="rounded bg-gray-100" style="width: 40px; height: 40px; object-fit: cover;"></td>
                        <td class="font-medium text-gray-900">${p.name}</td>
                        <td>${formatCurrency(p.price)}</td>
                        <td>
                            <span class="${p.stock < 10 ? 'text-red-600 font-bold' : 'text-gray-600'}">
                                ${p.stock} un
                            </span>
                        </td>
                        <td class="text-gray-500">${formatCurrency(p.price * p.stock)}</td>
                        <td class="text-right">
                            <button class="btn btn-secondary btn-sm" onclick="editProduct('${p.id}')">
                                <i data-lucide="edit-2" style="width: 14px;"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteProduct('${p.id}')">
                                <i data-lucide="trash-2" style="width: 14px;"></i>
                            </button>
                        </td>
                    `;
                    if (tbody) tbody.appendChild(tr);
                });
            }
            lucide.createIcons();
        }

        function openProductModal(id = null) {
            const modal = document.getElementById('product-modal');
            const title = document.getElementById('modal-title');
            const form = document.getElementById('product-form');

            // Populate Categories
            const catSelect = document.getElementById('prod-category');
            catSelect.innerHTML = '<option value="Outros">Selecione ou deixe Outros</option>';
            categories.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.innerText = cat;
                catSelect.appendChild(opt);
            });

            modal.classList.remove('hidden');
            
            if (id) {
                const product = products.find(p => p.id === id);
                title.innerText = 'Editar Produto';
                document.getElementById('prod-id').value = product.id;
                document.getElementById('prod-name').value = product.name;
                document.getElementById('prod-price').value = product.price;
                document.getElementById('prod-stock').value = product.stock;
                document.getElementById('prod-image').value = product.image || '';
                document.getElementById('prod-category').value = product.category || 'Outros';
            } else {
                title.innerText = 'Adicionar Novo Produto';
                form.reset();
                document.getElementById('prod-id').value = '';
                document.getElementById('prod-category').value = 'Outros';
            }
        }

        function closeProductModal() {
            document.getElementById('product-modal').classList.add('hidden');
        }

        function editProduct(id) { openProductModal(id); }

        function deleteProduct(id) {
            confirmDialog('Excluir produto', 'Tem certeza que deseja excluir este produto?', { icon: 'warning' }).then(async ok => {
                if (!ok) return;
                try {
                    await FirestoreService.deleteProduct(id);
                    toastSuccess('Produto excluído!');
                } catch(e) {
                    console.error(e);
                    toastError('Erro ao excluir produto');
                }
            });
        }

        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('prod-id').value;
            const name = document.getElementById('prod-name').value;
            const price = parseFloat(document.getElementById('prod-price').value);
            const stock = parseInt(document.getElementById('prod-stock').value);
            const image = document.getElementById('prod-image').value;
            const category = document.getElementById('prod-category').value;

            try {
                if (id) {
                    await FirestoreService.updateProduct(id, { name, price, stock, image, category });
                    toastSuccess('Produto atualizado!');
                } else {
                    await FirestoreService.addProduct({ name, price, stock, image, category });
                    toastSuccess('Produto criado!');
                }
                closeProductModal();
            } catch (err) {
                console.error(err);
                toastError('Erro ao salvar produto');
            }
        });

        // --- POS (VENDAS) ---
        let selectedPosCategory = null;

        function renderPosGrid() {
            const grid = document.getElementById('pos-grid');
            const chips = document.getElementById('pos-categories');
            const search = document.getElementById('pos-search').value.toLowerCase();
            grid.innerHTML = '';
            chips.innerHTML = '';
            const allCategories = [...new Set((products || []).map(p => p.category || 'Outros'))].sort();
            if (allCategories.length === 0) {
                grid.innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">Nenhum produto cadastrado.</p>';
                lucide.createIcons();
                return;
            }
            if (!selectedPosCategory || !allCategories.includes(selectedPosCategory)) {
                selectedPosCategory = allCategories[0];
            }
            allCategories.forEach(cat => {
                const chip = document.createElement('div');
                chip.className = `chip ${cat === selectedPosCategory ? 'selected' : ''}`;
                chip.innerText = cat;
                chip.onclick = () => { selectedPosCategory = cat; renderPosGrid(); };
                chips.appendChild(chip);
            });
            let filtered = products.filter(p => {
                const cat = p.category || 'Outros';
                const inCat = cat === selectedPosCategory;
                const matches = p.name.toLowerCase().includes(search);
                return inCat && matches;
            });
            filtered.sort((a, b) => {
                const aAvail = a.stock > 0 ? 1 : 0;
                const bAvail = b.stock > 0 ? 1 : 0;
                if (bAvail - aAvail !== 0) return (bAvail - aAvail);
                return a.name.localeCompare(b.name);
            });
            if (filtered.length === 0) {
                grid.innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">Nenhum produto encontrado nesta categoria.</p>';
                lucide.createIcons();
                return;
            }
            filtered.forEach(p => {
                const div = document.createElement('div');
                div.className = `card product-card ${p.stock <= 0 ? 'disabled' : ''}`;
                const imgUrl = p.image || 'https://via.placeholder.com/150?text=Produto';
                div.innerHTML = `
                    <img src="${imgUrl}" class="product-img">
                    <h4 class="font-bold text-sm mb-1 truncate" title="${p.name}">${p.name}</h4>
                    <div class="flex justify-between items-end mt-auto">
                        <span class="text-blue-600 font-bold">${formatCurrency(p.price)}</span>
                        <span class="text-xs text-gray-500">${p.stock} est.</span>
                    </div>
                `;
                div.onclick = () => addToCart(p);
                grid.appendChild(div);
            });
            lucide.createIcons();
        }

        function selectPosCategory(cat) {
            selectedPosCategory = cat;
            renderPosGrid();
        }

        // Helper because template string onclick loses scope if passing object
        function addToCartWrapper(id) {
            const p = products.find(x => x.id === id);
            if(p) addToCart(p);
        }

        function filterPosProducts() { renderPosGrid(); }

        function addToCart(product) {
            if (product.stock <= 0) return;
            
            const existing = cart.find(item => item.id === product.id);
            if (existing) {
                if (existing.qty < product.stock) {
                    existing.qty++;
                } else {
                    toastError('Estoque insuficiente!');
                }
            } else {
                cart.push({ ...product, qty: 1 });
            }
            renderCart();
            saveData();
        }

        function removeFromCart(id) {
            cart = cart.filter(item => item.id !== id);
            renderCart();
            saveData();
        }

        function updateCartQty(id, delta) {
            const item = cart.find(i => i.id === id);
            if (!item) return;

            const product = products.find(p => p.id === id);
            const newQty = item.qty + delta;

            if (newQty > 0 && newQty <= product.stock) {
                item.qty = newQty;
            } else if (newQty <= 0) {
                removeFromCart(id);
                return; // renderCart called inside
            } else {
                toastWarning('Limite de estoque atingido!');
            }
            renderCart();
            saveData();
        }

        function renderCart() {
            const container = document.getElementById('cart-items');
            container.innerHTML = '';

            let total = 0;

            if (cart.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 mt-10 flex flex-col items-center gap-2"><i data-lucide="shopping-cart" size="48" class="text-gray-300"></i><p>Carrinho vazio</p></div>';
                document.getElementById('btn-checkout').disabled = true;
            } else {
                document.getElementById('btn-checkout').disabled = false;
                cart.forEach(item => {
                    total += item.price * item.qty;
                    const el = document.createElement('div');
                    el.className = 'cart-item';
                    el.innerHTML = `
                        <div class="cart-item-info">
                            <span class="cart-item-title">${item.name}</span>
                            <span class="cart-item-meta">${formatCurrency(item.price)} un.</span>
                        </div>
                        <div class="cart-controls">
                            <button class="cart-item-btn text-gray-600" onclick="updateCartQty('${item.id}', -1)">
                                <i data-lucide="minus" style="width: 14px;"></i>
                            </button>
                            <span class="cart-qty">${item.qty}</span>
                            <button class="cart-item-btn text-gray-600" onclick="updateCartQty('${item.id}', 1)">
                                <i data-lucide="plus" style="width: 14px;"></i>
                            </button>
                        </div>
                        <button class="cart-item-btn text-red-500 border-red-100 hover:bg-red-50 ml-3" onclick="removeFromCart('${item.id}')" title="Remover">
                            <i data-lucide="trash-2" style="width: 16px;"></i>
                        </button>
                    `;
                    container.appendChild(el);
                });
            }

            document.getElementById('cart-subtotal').innerText = formatCurrency(total);
            document.getElementById('cart-total').innerText = formatCurrency(total);
            document.getElementById('pay-total').innerText = formatCurrency(total);
            lucide.createIcons();
        }

        // --- CHECKOUT ---
        let selectedPaymentMethods = [];
        let isSplitPayment = false;
        let checkoutTotal = 0;

        function openPaymentModal() {
            const modal = document.getElementById('payment-modal');
            checkoutTotal = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
            
            document.getElementById('pay-total').innerText = formatCurrency(checkoutTotal);
            
            // Reset State
            selectedPaymentMethods = [];
            isSplitPayment = false;
            document.getElementById('split-payment-toggle').checked = false;
            toggleSplitPayment(); // Reset UI
            
            renderPaymentOptions();
            modal.classList.remove('hidden');
        }

        function toggleSplitPayment() {
            isSplitPayment = document.getElementById('split-payment-toggle').checked;
            const splitSection = document.getElementById('split-payment-values');
            
            // Reset selection when toggling
            selectedPaymentMethods = [];
            renderPaymentOptions();

            if (isSplitPayment) {
                // Wait for selection to show inputs
                splitSection.classList.add('hidden'); 
            } else {
                splitSection.classList.add('hidden');
            }
        }

        function renderPaymentOptions() {
            const optionsContainer = document.getElementById('payment-options');
            optionsContainer.className = 'payment-modal-grid'; 
            optionsContainer.innerHTML = '';

            paymentMethods.forEach(method => {
                const btn = document.createElement('div');
                const isSelected = selectedPaymentMethods.includes(method);
                
                let classes = 'payment-method-btn';
                if (isSelected) classes += ' selected';
                
                // Icon mapping
                let icon = 'credit-card';
                const mLower = method.toLowerCase();
                if (mLower.includes('pix')) icon = 'qr-code';
                else if (mLower.includes('dinheiro')) icon = 'banknote';
                else if (mLower.includes('crédito')) icon = 'credit-card';
                else if (mLower.includes('débito')) icon = 'credit-card';
                else if (mLower.includes('fiado')) icon = 'user';
                else if (mLower.includes('stripe')) icon = 'badge-dollar-sign';
                else if (mLower.includes('mercado')) icon = 'shopping-cart';
                
                btn.className = classes;
                btn.innerHTML = `<i data-lucide="${icon}" style="width: 20px; height: 20px;"></i><span style="font-size: 0.9rem;">${method}</span>`;
                btn.onclick = () => selectPaymentMethod(method);
                optionsContainer.appendChild(btn);
            });

            updateSplitUI();
            renderPixDisplay();
            renderExternalPayment();
            renderFiadoSelection();
            renderCashChange();
            lucide.createIcons();
        }

        function renderExternalPayment() {
            const container = document.getElementById('pix-display-container');
            // Append external payment hints below Pix box or alone
            const hasStripe = selectedPaymentMethods.some(m => m.toLowerCase().includes('stripe'));
            const hasMP = selectedPaymentMethods.some(m => m.toLowerCase().includes('mercado'));
            if (!hasStripe && !hasMP) return;
            const parts = [];
            if (hasStripe) {
                const url = integrations.stripeLink || '';
                parts.push(`
                    <div class="pix-display-box">
                        <h4 class="font-bold text-blue-700 mb-2">Pagamento via Stripe</h4>
                        <div class="text-sm mt-2">
                            <p class="text-gray-600">Use o link configurado para concluir o pagamento:</p>
                            ${url ? `<a href="${url}" target="_blank" class="btn btn-primary mt-2"><i data-lucide="external-link"></i> Abrir Stripe</a>` : '<div class="text-xs text-gray-500">Nenhum link configurado</div>'}
                        </div>
                    </div>
                `);
            }
            if (hasMP) {
                const url = integrations.mpLink || '';
                parts.push(`
                    <div class="pix-display-box">
                        <h4 class="font-bold text-indigo-700 mb-2">Pagamento via Mercado Pago</h4>
                        <div class="text-sm mt-2">
                            <p class="text-gray-600">Use o link configurado para concluir o pagamento:</p>
                            ${url ? `<a href="${url}" target="_blank" class="btn btn-primary mt-2"><i data-lucide="external-link"></i> Abrir Mercado Pago</a>` : '<div class="text-xs text-gray-500">Nenhum link configurado</div>'}
                        </div>
                    </div>
                `);
            }
            container.innerHTML += parts.join('');
        }
        function renderPixDisplay() {
            const container = document.getElementById('pix-display-container');
            container.innerHTML = '';
            
            const isPixSelected = selectedPaymentMethods.some(m => m.toLowerCase().includes('pix'));
            
            if (isPixSelected) {
                const key = pixConfig.key || 'Chave não configurada';
                const name = pixConfig.name || 'Beneficiário não configurado';
                const qrUrl = pixConfig.qrImage ? pixConfig.qrImage : (key && key !== 'Chave não configurada' ? `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(key)}` : '');
                
                container.innerHTML = `
                    <div class="pix-display-box">
                        <h4 class="font-bold text-green-700 mb-2">Pagamento via Pix</h4>
                        <div class="flex flex-col items-center justify-center bg-white p-2 rounded border inline-block">
                             ${qrUrl ? `<img src="${qrUrl}" alt="QR Code Pix" width="150" height="150">` : '<div class="w-32 h-32 bg-gray-100 flex items-center justify-center text-xs text-center text-gray-500">QR Code indisponível</div>'}
                        </div>
                        <div class="text-sm mt-2">
                            <p class="font-bold text-gray-800">Chave: <span class="select-all bg-white px-2 py-1 rounded border border-gray-200">${key}</span></p>
                            <p class="text-gray-600 mt-1">Beneficiário: ${name}</p>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Peça para o cliente enviar o comprovante.</p>
                    </div>
                `;
            }
        }

        function renderFiadoSelection() {
            const container = document.getElementById('fiado-customer-container');
            if (!container) return;
            const hasFiado = selectedPaymentMethods.some(m => m.toLowerCase().includes('fiado'));
            if (!hasFiado) {
                container.innerHTML = '';
                return;
            }
            const options = customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            container.innerHTML = `
                <div class="mt-4 p-3 rounded border bg-yellow-50">
                    <label class="input-label mb-2">Selecione o Cliente (Fiado)</label>
                    <div class="flex gap-2">
                        <select id="fiado-customer-select" class="input">${options}</select>
                        <button class="btn btn-secondary" onclick="openCustomerModal()"><i data-lucide="user-plus"></i> Novo Cliente</button>
                    </div>
                    <p class="text-xs text-gray-600 mt-2">A venda será registrada no perfil do cliente.</p>
                </div>
            `;
        }

        function renderCashChange() {
            const container = document.getElementById('cash-change-container');
            if (!container) return;
            const hasCash = selectedPaymentMethods.some(m => m.toLowerCase().includes('dinheiro'));
            if (!hasCash) {
                container.innerHTML = '';
                return;
            }
            container.innerHTML = `
                <div class="mt-4 p-4 rounded border bg-green-50">
                    <label class="input-label mb-2">Valor recebido (Dinheiro)</label>
                    <div class="flex gap-2 items-end">
                        <input type="number" id="cash-received-input" class="input" step="0.01" min="0" placeholder="Ex.: 100.00" oninput="updateCashChange()">
                        <div class="flex-1 text-right">
                            <div class="text-sm text-gray-500">Troco</div>
                            <div id="cash-change-output" class="font-bold text-green-700 text-xl">R$ 0,00</div>
                        </div>
                    </div>
                </div>
            `;
            updateCashChange();
        }

        function updateCashChange() {
            const receivedEl = document.getElementById('cash-received-input');
            const outputEl = document.getElementById('cash-change-output');
            if (!receivedEl || !outputEl) return;
            const received = parseFloat(receivedEl.value) || 0;
            let cashPortion = 0;
            if (!isSplitPayment) {
                cashPortion = checkoutTotal;
            } else {
                if (selectedPaymentMethods.length === 2) {
                    const idxCash = selectedPaymentMethods.findIndex(m => m.toLowerCase().includes('dinheiro'));
                    if (idxCash === 0) {
                        cashPortion = parseFloat(document.getElementById('val-method-1').value) || 0;
                    } else if (idxCash === 1) {
                        cashPortion = parseFloat(document.getElementById('val-method-2').value) || 0;
                    }
                }
            }
            const change = Math.max(received - cashPortion, 0);
            outputEl.innerText = formatCurrency(change);
        }

        function selectPaymentMethod(method) {
            if (!isSplitPayment) {
                // Single Mode: Select one, replace others
                selectedPaymentMethods = [method];
            } else {
                // Split Mode: Toggle (Max 2)
                if (selectedPaymentMethods.includes(method)) {
                    selectedPaymentMethods = selectedPaymentMethods.filter(m => m !== method);
                } else {
                    if (selectedPaymentMethods.length < 2) {
                        selectedPaymentMethods.push(method);
                    } else {
                        // If 2 already selected, replace the second one (or warn? Replace is better UX)
                        // Actually, let's just ignore or replace the last one.
                        // Let's prevent > 2
                        toastWarning('Em pagamento dividido, selecione apenas 2 formas.');
                        return;
                    }
                }
            }
            renderPaymentOptions();
        }

        function updateSplitUI() {
            const splitSection = document.getElementById('split-payment-values');
            
            if (isSplitPayment && selectedPaymentMethods.length === 2) {
                splitSection.classList.remove('hidden');
                document.getElementById('label-method-1').innerText = selectedPaymentMethods[0];
                document.getElementById('label-method-2').innerText = selectedPaymentMethods[1];
                
                // Initialize values if empty
                const v1 = document.getElementById('val-method-1');
                const v2 = document.getElementById('val-method-2');
                
                if (!v1.value || !v2.value) {
                    v1.value = (checkoutTotal / 2).toFixed(2);
                    v2.value = (checkoutTotal / 2).toFixed(2);
                }
                validateSplitTotal();
                renderCashChange();
            } else {
                splitSection.classList.add('hidden');
                renderCashChange();
            }
        }

        function calculateSplit(changedInputIndex) {
            const v1 = document.getElementById('val-method-1');
            const v2 = document.getElementById('val-method-2');
            
            const val1 = parseFloat(v1.value) || 0;
            const val2 = parseFloat(v2.value) || 0;

            if (changedInputIndex === 1) {
                v2.value = (checkoutTotal - val1).toFixed(2);
            } else {
                v1.value = (checkoutTotal - val2).toFixed(2);
            }
            validateSplitTotal();
            updateCashChange();
        }

        function validateSplitTotal() {
            const v1 = parseFloat(document.getElementById('val-method-1').value) || 0;
            const v2 = parseFloat(document.getElementById('val-method-2').value) || 0;
            const msg = document.getElementById('split-validation-msg');
            
            const sum = v1 + v2;
            const diff = Math.abs(checkoutTotal - sum);

            if (diff < 0.02) { // Tolerance for float errors
                msg.innerText = 'Total correto!';
                msg.className = 'text-xs mt-2 text-right font-bold text-green-600';
                return true;
            } else {
                msg.innerText = `Soma: ${formatCurrency(sum)} (Faltam ${formatCurrency(checkoutTotal - sum)})`;
                msg.className = 'text-xs mt-2 text-right font-bold text-red-600';
                return false;
            }
        }

        function closePaymentModal() {
            document.getElementById('payment-modal').classList.add('hidden');
        }

        async function confirmPayment() {
            // Validation
            if (selectedPaymentMethods.length === 0) {
                toastWarning('Selecione uma forma de pagamento!');
                return;
            }

            if (isSplitPayment && selectedPaymentMethods.length !== 2) {
                toastWarning('Selecione 2 formas de pagamento para dividir.');
                return;
            }

            const isFiado = selectedPaymentMethods.some(m => m.toLowerCase().includes('fiado'));
            if (isSplitPayment && isFiado) {
                toastWarning('Fiado não suporta pagamento dividido neste momento. Desative divisão para registrar fiado.');
                return;
            }

            let finalPaymentDescription = '';

            if (isSplitPayment) {
                if (!validateSplitTotal()) {
                    toastError('A soma dos valores deve ser igual ao total da venda.');
                    return;
                }
                const v1 = parseFloat(document.getElementById('val-method-1').value);
                const v2 = parseFloat(document.getElementById('val-method-2').value);
                const m1 = selectedPaymentMethods[0];
                const m2 = selectedPaymentMethods[1];
                
                finalPaymentDescription = `${m1} (${formatCurrency(v1)}) + ${m2} (${formatCurrency(v2)})`;
            } else {
                finalPaymentDescription = selectedPaymentMethods[0];
            }

            const isPixOnly = !isSplitPayment && selectedPaymentMethods[0]?.toLowerCase().includes('pix');
            if (isPixOnly) {
                const totalPix = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
                pendingSaleData = { total: totalPix };
                document.getElementById('payment-modal').classList.add('hidden');
                startPixPayment(totalPix);
                return;
            }
            
            
            // Create Sale Object
            const total = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
            const sale = {
                id: Date.now(),
                date: new Date().toISOString(),
                items: [...cart],
                total: total,
                paymentMethod: finalPaymentDescription,
                context: { type: 'counter' }
            };

            // Se fiado: verificar limite de crédito do cliente
            if (isFiado) {
                const selectEl = document.getElementById('fiado-customer-select');
                const customerId = selectEl ? parseInt(selectEl.value) : null;
                if (!customerId) {
                    toastWarning('Selecione um cliente para registrar o fiado.');
                    return;
                }
                const customer = customers.find(c => c.id === customerId);
                if (customer) {
                    const balance = computeCustomerBalance(customer);
                    const limit = (customer.creditLimit != null && customer.creditLimit !== '') ? Number(customer.creditLimit) : 0;
                    if (limit > 0 && (balance + total) > limit) {
                        toastError(`Limite de crédito excedido. Saldo atual: ${formatCurrency(balance)}. Limite: ${formatCurrency(limit)}. Não é possível registrar esta venda no fiado.`);
                        return;
                    }
                }
            }

            // Deduct stock and Save Sale
            try {
                // Update Stock
                for (const cartItem of cart) {
                    const product = products.find(p => p.id === cartItem.id);
                    if (product) {
                        await FirestoreService.updateProduct(cartItem.id, { stock: product.stock - cartItem.qty });
                    }
                }
                
                // Add Sale
                const docRef = await FirestoreService.addSale(sale);
                sale.id = docRef.id; // Update ID with Firestore ID
                
                // If Fiado, update customer
                if (isFiado) {
                     // ... existing fiado logic but using Firestore ...
                     // existing logic calls addFiadoEntry(customerId, sale)
                     // I should check addFiadoEntry implementation
                }
            } catch (err) {
                console.error(err);
                toastError('Erro ao salvar venda');
                return;
            }
            
            // sales.unshift(sale); // Removed manual update

            
            // If Fiado, link to customer and create ledger entry
            if (isFiado) {
                const selectEl = document.getElementById('fiado-customer-select');
                const customerId = selectEl ? parseInt(selectEl.value) : null;
                if (!customerId) {
                    toastWarning('Selecione um cliente para registrar o fiado.');
                    return;
                }
                addFiadoEntry(customerId, sale);
            }

            cart = []; // Clear cart


            saveData();
            try { updateNotifications(); } catch(e) {}
            
            renderCart();
            renderPosGrid(); // Update grid (disable items out of stock)
            closePaymentModal();
            toastSuccess('Venda realizada com sucesso!');
            showPostSaleOptions(sale.id);

            // Show NF-e preview if enabled
            const nfeConfig = JSON.parse(localStorage.getItem(STORAGE_KEY_NFE) || '{}');
            if (nfeConfig.enabled) {
                previewNFe(sale);
            }
        }
        
        function getToken() {
            try {
                const userStr = localStorage.getItem('user');
                return userStr ? JSON.parse(userStr).token : null;
            } catch (e) { return null; }
        }

        function getAuthHeaders() {
            const token = getToken();
            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['Authorization'] = `Bearer ${token}`;
            return headers;
        }

        function startPixPayment(amount) {
            const qrBox = document.getElementById('pix-live-qr');
            const statusEl = document.getElementById('pix-live-status');
            qrBox.innerHTML = '<div class="spinner mx-auto my-4"></div>';
            statusEl.innerText = 'Gerando cobrança Pix...';
            
            document.getElementById('pix-live-modal').classList.remove('hidden');

            fetch('/api/pix/charge', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({ amount, description: 'Venda PDV' })
            }).then(r => {
                if (!r.ok) throw new Error('Erro na API');
                return r.json();
            }).then(d => {
                currentPixTxid = d.txid;
                
                // Use Base64 QR if available, otherwise fallback (or generate)
                const img = d.qr_code_base64 
                    ? `<img src="${d.qr_code_base64}" class="mx-auto mb-4 border rounded p-1" width="200" height="200">`
                    : `<img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(d.qr_code)}" class="mx-auto mb-4 border rounded p-1" width="200" height="200">`;
                
                const copiaCola = `
                    <div class="text-sm w-full max-w-xs mx-auto">
                        <p class="font-bold mb-1 text-gray-700">Copia e Cola:</p>
                        <div class="flex gap-2">
                            <input type="text" readonly value="${d.qr_code}" class="flex-1 p-2 border rounded text-xs bg-gray-50 font-mono" id="pix-copy-input">
                            <button onclick="copyPixCode()" class="btn btn-secondary p-2" title="Copiar"><i data-lucide="copy"></i></button>
                        </div>
                    </div>
                    ${d.mock_payment_url ? `<a href="${d.mock_payment_url}" target="_blank" class="block mt-4 text-xs text-blue-600 hover:underline">Simular Pagamento (Ambiente de Teste)</a>` : ''}
                `;
                
                qrBox.innerHTML = img + copiaCola;
                statusEl.innerHTML = '<span class="text-yellow-600 font-bold flex items-center justify-center gap-2"><div class="spinner w-4 h-4 border-yellow-600"></div> Aguardando pagamento...</span>';
                lucide.createIcons();

                pixPollInterval = setInterval(() => {
                    fetch(`/api/pix/charge/${currentPixTxid}/status`, {
                        headers: getAuthHeaders()
                    }).then(r => r.json()).then(s => {
                        if (s.status === 'approved' || s.status === 'paid') {
                            clearInterval(pixPollInterval);
                            pixPollInterval = null;
                            statusEl.className = 'text-green-600 font-bold text-lg mb-4';
                            statusEl.innerText = 'Pagamento Confirmado!';
                            setTimeout(() => finalizePixSale(), 1000);
                        }
                    }).catch(() => {});
                }, 3000);
            }).catch(err => {
                console.error(err);
                qrBox.innerHTML = `<div class="text-red-500 py-4">Erro ao gerar Pix. Tente novamente.<br><span class="text-xs text-gray-400">${err.message}</span></div>`;
                statusEl.innerText = '';
            });
        }
        
        function copyPixCode() {
            const input = document.getElementById('pix-copy-input');
            input.select();
            document.execCommand('copy');
            toastSuccess('Código Pix copiado!');
        }
        
        function closePixLiveModal() {
            document.getElementById('pix-live-modal').classList.add('hidden');
            if (pixPollInterval) {
                clearInterval(pixPollInterval);
                pixPollInterval = null;
            }
        }
        
        async function finalizePixSale() {
            const total = pendingSaleData?.total || cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
            const sale = {
                id: Date.now(),
                date: new Date().toISOString(),
                items: [...cart],
                total: total,
                paymentMethod: 'Pix',
                context: { type: 'counter' }
            };
            try {
                // Update Stock
                for (const cartItem of cart) {
                    const product = products.find(p => p.id === cartItem.id);
                    if (product) {
                        await FirestoreService.updateProduct(cartItem.id, { stock: product.stock - cartItem.qty });
                    }
                }
                
                // Add Sale
                const docRef = await FirestoreService.addSale(sale);
                sale.id = docRef.id;
            } catch (err) {
                console.error(err);
                toastError('Erro ao salvar venda');
                return;
            }

             cart = []; // Clear cart


            saveData();
            try { updateNotifications(); } catch(e) {}
            
            renderCart();
            renderPosGrid();
            closePixLiveModal();
            toastSuccess('Pagamento Pix confirmado e venda registrada!');
            showPostSaleOptions(sale.id);
            const nfeConfig = JSON.parse(localStorage.getItem(STORAGE_KEY_NFE) || '{}');
            if (nfeConfig.enabled) {
                previewNFe(sale);
            }
        }

        // --- SALES HISTORY ---
        let currentSalesFilter = 'day';
        function getFilteredSales(period) {
            const now = new Date();
            return sales.filter(s => {
                const d = new Date(s.date);
                if (period === 'day') return d.getDate() === now.getDate() && d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                if (period === 'month') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                if (period === 'year') return d.getFullYear() === now.getFullYear();
                return true;
            });
        }
        function filterSales(period) {
            currentSalesFilter = period;
            const tbody = document.getElementById('sales-table-body');
            const emptyState = document.getElementById('sales-empty-state');
            const now = new Date();
            tbody.innerHTML = '';

            let filtered = getFilteredSales(period);

            // Update stats
            const total = filtered.reduce((acc, s) => acc + s.total, 0);
            document.getElementById('sales-count').innerText = filtered.length;
            document.getElementById('sales-total').innerText = formatCurrency(total);
            
            // Debtors summary and list
            const debtors = (customers || []).map(c => ({...c, balance: computeCustomerBalance(c)})).filter(c => c.balance > 0);
            document.getElementById('sales-debtors-count').innerText = debtors.length;
            const totalFiado = debtors.reduce((acc, c) => acc + c.balance, 0);
            document.getElementById('sales-debtors-total').innerText = formatCurrency(totalFiado);
            const listDebtors = document.getElementById('sales-debtors-list');
            listDebtors.innerHTML = '';
            debtors.forEach(c => {
                const card = document.createElement('div');
                card.className = 'customer-card';
                card.innerHTML = `
                    <img class="avatar" src="${c.photo || 'https://via.placeholder.com/80?text=Foto'}" alt="Foto">
                    <div class="flex-1">
                        <div class="font-bold">${c.name}</div>
                        <div class="text-red-600 font-bold">Saldo: ${formatCurrency(c.balance)}</div>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="navigateToCustomer(${c.id})"><i data-lucide="eye"></i> Ver Perfil</button>
                `;
                listDebtors.appendChild(card);
            });

            // Render table
            if (filtered.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            emptyState.classList.add('hidden');

            filtered.forEach(s => {
                const dateStr = new Date(s.date).toLocaleString('pt-BR');
                const itemsSummary = s.items.map(i => `${i.qty}x ${i.name}`).join(', ');
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-sm text-gray-500">#${String(([...sales].sort((a,b)=> new Date(a.date) - new Date(b.date))).findIndex(x => x.id === s.id)).padStart(2, '0')}</td>
                    <td>${dateStr}</td>
                    <td class="text-sm truncate max-w-xs" title="${itemsSummary}">${itemsSummary}</td>
                    <td><span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${s.paymentMethod}</span></td>
                    <td class="font-bold text-green-600">${formatCurrency(s.total)}</td>
                    <td class="flex gap-2">
                        <button class="btn btn-sm btn-secondary" title="Imprimir Cupom" onclick="printReceipt(${s.id})">
                            <i data-lucide="printer" style="width: 14px;"></i>
                        </button>
                        <button class="btn btn-sm btn-secondary text-green-600" title="Emitir NF-e" onclick="emitNfe(${s.id})">
                            <i data-lucide="file-text" style="width: 14px;"></i>
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="openSaleEditModal(${s.id})">
                            <i data-lucide="edit-2" style="width: 14px;"></i>
                        </button>
                        <button class="btn btn-sm btn-danger text-red-600 hover:bg-red-50" onclick="deleteSale(${s.id})">
                            <i data-lucide="trash-2" style="width: 14px;"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        function exportSalesCSV() {
            const filtered = getFilteredSales(currentSalesFilter);
            const headers = ['ID', 'Data', 'Itens', 'Forma Pagamento', 'Total (R$)'];
            const rows = filtered.map(s => {
                const dateStr = new Date(s.date).toLocaleString('pt-BR');
                const itemsStr = s.items.map(i => `${i.qty}x ${i.name}`).join('; ');
                return [s.id, dateStr, `"${itemsStr.replace(/"/g, '""')}"`, s.paymentMethod, s.total.toFixed(2).replace('.', ',')];
            });
            const BOM = '\uFEFF';
            const csv = BOM + [headers.join(';'), ...rows.map(r => r.join(';'))].join('\r\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vendas_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            toastSuccess('Histórico de vendas exportado (CSV).');
        }

        function exportSalesPDF() {
            const filtered = getFilteredSales(currentSalesFilter);
            if (filtered.length === 0) {
                toastWarning('Nenhuma venda para exportar.');
                return;
            }
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
                doc.setFontSize(14);
                doc.text('Histórico de Vendas - Flokite System', 14, 12);
                doc.setFontSize(8);
                let y = 20;
                const colW = [18, 38, 95, 45, 25];
                doc.setFont(undefined, 'bold');
                doc.text('ID', 14, y);
                doc.text('Data', 14 + colW[0], y);
                doc.text('Itens', 14 + colW[0] + colW[1], y);
                doc.text('Pagamento', 14 + colW[0] + colW[1] + colW[2], y);
                doc.text('Total', 14 + colW[0] + colW[1] + colW[2] + colW[3], y);
                y += 5;
                doc.setFont(undefined, 'normal');
                filtered.forEach(s => {
                    if (y > 190) { doc.addPage('a4', 'landscape'); y = 20; }
                    const dateStr = new Date(s.date).toLocaleString('pt-BR');
                    const itemsStr = (s.items.map(i => i.qty + 'x ' + i.name).join(', ') || '').substring(0, 50);
                    doc.text(String(s.id).slice(-6), 14, y);
                    doc.text(dateStr, 14 + colW[0], y);
                    doc.text(itemsStr, 14 + colW[0] + colW[1], y);
                    doc.text(s.paymentMethod || '', 14 + colW[0] + colW[1] + colW[2], y);
                    doc.text('R$ ' + s.total.toFixed(2), 14 + colW[0] + colW[1] + colW[2] + colW[3], y);
                    y += 5;
                });
                doc.save(`vendas_${new Date().toISOString().slice(0,10)}.pdf`);
                toastSuccess('Histórico de vendas exportado (PDF).');
            } catch (e) {
                toastError('Erro ao gerar PDF. Verifique se a página carregou completamente.');
            }
        }

        function exportProductsCSV() {
            const headers = ['Nome', 'Categoria', 'Preço (R$)', 'Estoque', 'Valor Total (R$)'];
            const rows = products.map(p => {
                const total = (p.price || 0) * (p.stock || 0);
                return [p.name.replace(/"/g, '""'), p.category || '', (p.price || 0).toFixed(2).replace('.', ','), String(p.stock || 0), total.toFixed(2).replace('.', ',')];
            });
            const BOM = '\uFEFF';
            const csv = BOM + [headers.join(';'), ...rows.map(r => r.map(c => `"${c}"`).join(';'))].join('\r\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `estoque_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            toastSuccess('Lista de estoque exportada (CSV).');
        }

        function exportProductsPDF() {
            if (products.length === 0) {
                toastWarning('Nenhum produto para exportar.');
                return;
            }
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
                doc.setFontSize(14);
                doc.text('Lista de Estoque - Flokite System', 14, 12);
                doc.setFontSize(8);
                let y = 20;
                const colW = [70, 30, 28, 22, 35];
                doc.setFont(undefined, 'bold');
                doc.text('Nome', 14, y);
                doc.text('Categoria', 14 + colW[0], y);
                doc.text('Preço', 14 + colW[0] + colW[1], y);
                doc.text('Estoque', 14 + colW[0] + colW[1] + colW[2], y);
                doc.text('Valor Total', 14 + colW[0] + colW[1] + colW[2] + colW[3], y);
                y += 5;
                doc.setFont(undefined, 'normal');
                products.forEach(p => {
                    if (y > 190) { doc.addPage('a4', 'landscape'); y = 20; }
                    const total = (p.price || 0) * (p.stock || 0);
                    doc.text((p.name || '').substring(0, 35), 14, y);
                    doc.text(p.category || '', 14 + colW[0], y);
                    doc.text('R$ ' + (p.price || 0).toFixed(2), 14 + colW[0] + colW[1], y);
                    doc.text(String(p.stock || 0), 14 + colW[0] + colW[1] + colW[2], y);
                    doc.text('R$ ' + total.toFixed(2), 14 + colW[0] + colW[1] + colW[2] + colW[3], y);
                    y += 5;
                });
                doc.save(`estoque_${new Date().toISOString().slice(0,10)}.pdf`);
                toastSuccess('Lista de estoque exportada (PDF).');
            } catch (e) {
                toastError('Erro ao gerar PDF. Verifique se a página carregou completamente.');
            }
        }

        function navigateToCustomer(id) {
            const navEl = Array.from(document.querySelectorAll('.nav-item')).find(el => el.innerText.includes('Fiado'));
            if (navEl) {
                navEl.click();
                renderCustomerDetail(id);
            } else {
                navigate('fiado');
                renderCustomerDetail(id);
            }
        }

        function deleteSale(id) {
            confirmDialog('Excluir venda', 'Tem certeza que deseja excluir esta venda? O estoque será estornado.', { icon: 'warning' }).then(ok => {
                if (!ok) return;
                const sale = sales.find(s => s.id === id);
                if (!sale) return;
                sale.items.forEach(item => {
                    const prod = products.find(p => p.id === item.id);
                    if (prod) prod.stock += item.qty;
                });
                sales = sales.filter(s => s.id !== id);
                saveData();
                filterSales('all');
                updateDashboard();
            });
        }

        function openSaleEditModal(id) {
            const sale = sales.find(s => s.id === id);
            if (!sale) return;
            
            document.getElementById('edit-sale-id').value = id;
            document.getElementById('display-sale-id').innerText = '#' + id.toString().slice(-6);
            document.getElementById('edit-sale-payment').value = sale.paymentMethod;
            
            document.getElementById('sale-edit-modal').classList.remove('hidden');
        }

        function closeSaleEditModal() {
            document.getElementById('sale-edit-modal').classList.add('hidden');
        }

        function saveSaleEdit() {
            const id = parseInt(document.getElementById('edit-sale-id').value);
            const newPayment = document.getElementById('edit-sale-payment').value;
            
            const index = sales.findIndex(s => s.id === id);
            if (index > -1) {
                sales[index].paymentMethod = newPayment;
                saveData();
                filterSales('all');
                closeSaleEditModal();
            }
        }

        function viewSaleDetails(id) {
            const sale = sales.find(s => s.id === id);
            if (!sale) return;
            
            const itemsList = sale.items.map(i => 
                `${i.qty}x ${i.name} (${formatCurrency(i.price)})`
            ).join('\n');

            Swal.fire({
                title: `Venda #${sale.id}`,
                html: `<p><strong>Data:</strong> ${new Date(sale.date).toLocaleString()}</p><p><strong>Pagamento:</strong> ${sale.paymentMethod}</p><hr><p><strong>Itens:</strong></p><p style="white-space:pre-wrap;text-align:left;">${itemsList}</p><hr><p><strong>TOTAL:</strong> ${formatCurrency(sale.total)}</p>`,
                icon: 'info',
                width: 420
            });
        }

        function renderApagarPage() {
            renderApagarCategories();
            renderApagarGrid();
            if (currentPayableId) {
                renderApagarDetail(currentPayableId);
            } else {
                document.getElementById('apagar-detail').classList.add('hidden');
                document.getElementById('apagar-detail-empty').classList.remove('hidden');
            }
            lucide.createIcons();
        }

        function renderApagarCategories() {
            const list = document.getElementById('apagar-categories-list');
            list.innerHTML = '';
            payableCategories.forEach((cat, index) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-gray-50 p-3 rounded border';
                li.innerHTML = `
                    <span>${cat}</span>
                    <div class="flex gap-2">
                        <button class="text-blue-500 hover:text-blue-700" onclick="editPayableCategory(${index})">
                            <i data-lucide="edit-2" style="width: 16px;"></i>
                        </button>
                        <button class="text-red-500 hover:text-red-700" onclick="removePayableCategory(${index})">
                            <i data-lucide="trash" style="width: 16px;"></i>
                        </button>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        function renderApagarGrid() {
            const grid = document.getElementById('apagar-grid');
            const search = (document.getElementById('apagar-search')?.value || '').toLowerCase();
            grid.innerHTML = '';
            const filtered = payables.filter(p => p.name.toLowerCase().includes(search));
            const grouped = {};
            filtered.forEach(p => {
                const cat = p.category || 'Outros';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(p);
            });
            const cats = Object.keys(grouped).sort();
            if (cats.length === 0) {
                grid.innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">Nenhuma conta encontrada.</p>';
                return;
            }
            cats.forEach(cat => {
                const section = document.createElement('div');
                section.className = 'col-span-full pos-category-section';
                section.innerHTML = `<h3 class="pos-category-title">${cat}</h3>`;
                grid.appendChild(section);
                const groupContainer = document.createElement('div');
                groupContainer.className = 'grid-cols-3 pos-category-group';
                grouped[cat].forEach(p => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <img src="${p.image || 'https://via.placeholder.com/150?text=Conta'}" class="product-img">
                        <h4 class="font-bold text-sm mb-1 truncate" title="${p.name}">${p.name}</h4>
                        <div class="text-sm text-gray-600">Vencimento: ${new Date(p.dueDate).toLocaleDateString('pt-BR')}</div>
                        <div class="flex justify-between mt-2">
                            <span class="text-blue-600 font-bold">${formatCurrency(p.total)}</span>
                            <span class="text-green-600 font-bold">${formatCurrency(sumPaid(p))} pago</span>
                        </div>
                        <div class="text-red-600 font-bold mt-1">${formatCurrency(p.total - sumPaid(p))} faltando</div>
                        <div class="flex gap-2 mt-3">
                            <button class="btn btn-sm btn-secondary" onclick="openPayableModal(${p.id})"><i data-lucide="edit-2"></i> Editar</button>
                            <button class="btn btn-sm btn-danger" onclick="deletePayable(${p.id})"><i data-lucide="trash"></i> Remover</button>
                            <button class="btn btn-sm btn-primary" onclick="renderApagarDetail(${p.id})"><i data-lucide="eye"></i> Detalhes</button>
                        </div>
                    `;
                    groupContainer.appendChild(card);
                });
                grid.appendChild(groupContainer);
            });
        }

        function sumPaid(p) {
            return (p.ledger || []).reduce((acc, l) => acc + (l.amount || 0), 0);
        }

        function renderApagarDetail(id) {
            currentPayableId = id;
            const p = payables.find(x => x.id === id);
            if (!p) return;
            document.getElementById('apagar-detail-empty').classList.add('hidden');
            const detail = document.getElementById('apagar-detail');
            detail.classList.remove('hidden');
            document.getElementById('payable-photo').src = p.image || 'https://via.placeholder.com/80?text=Conta';
            document.getElementById('payable-name').innerText = p.name;
            document.getElementById('payable-category').innerText = p.category || 'Outros';
            const paid = sumPaid(p);
            document.getElementById('payable-due').innerText = new Date(p.dueDate).toLocaleDateString('pt-BR');
            document.getElementById('payable-total').innerText = formatCurrency(p.total);
            document.getElementById('payable-paid').innerText = formatCurrency(paid);
            document.getElementById('payable-remaining').innerText = formatCurrency(p.total - paid);
            const ledgerEl = document.getElementById('payable-ledger');
            ledgerEl.innerHTML = '';
            (p.ledger || []).forEach(l => {
                const row = document.createElement('div');
                row.className = 'ledger-entry';
                row.innerHTML = `
                    <div class="flex-1">
                        <div class="font-bold">${new Date(l.date).toLocaleString('pt-BR')}</div>
                        <div class="text-sm text-gray-600">${l.note || ''}</div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-green-600 font-bold">${formatCurrency(l.amount)}</div>
                        <div class="flex gap-1">
                            <button class="btn btn-sm btn-secondary p-1" onclick="editPayablePayment(${l.id})" title="Editar">
                                <i data-lucide="edit-2" style="width: 14px; height: 14px;"></i>
                            </button>
                            <button class="btn btn-sm btn-danger p-1" onclick="deletePayablePayment(${l.id})" title="Excluir">
                                <i data-lucide="trash" style="width: 14px; height: 14px;"></i>
                            </button>
                        </div>
                    </div>
                `;
                ledgerEl.appendChild(row);
            });
            lucide.createIcons();
        }

        function openPayableModal(id = null) {
            const modal = document.getElementById('payable-modal');
            const title = document.getElementById('payable-modal-title');
            const form = document.getElementById('payable-form');
            
            // Populate Categories
            const catSelect = document.getElementById('payable-category');
            catSelect.innerHTML = '<option value="Outros">Selecione ou deixe Outros</option>';
            payableCategories.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.innerText = cat;
                catSelect.appendChild(opt);
            });

            modal.classList.remove('hidden');
            
            if (id) {
                const p = payables.find(x => x.id === id);
                if (!p) return;
                title.innerText = 'Editar Conta';
                document.getElementById('payable-id').value = p.id;
                document.getElementById('payable-name').value = p.name;
                document.getElementById('payable-category').value = p.category || 'Outros';
                document.getElementById('payable-date').value = p.dueDate;
                document.getElementById('payable-total').value = p.total;
                document.getElementById('payable-image').value = p.image || '';
                updatePayablePreview(p.image || '');
            } else {
                title.innerText = 'Nova Conta a Pagar';
                form.reset();
                document.getElementById('payable-id').value = '';
                document.getElementById('payable-category').value = 'Outros';
                document.getElementById('payable-date').value = new Date().toISOString().slice(0, 10);
                updatePayablePreview('');
            }
        }

        function closePayableModal() {
            document.getElementById('payable-modal').classList.add('hidden');
        }

        function fillPayable(name, category, image) {
            document.getElementById('payable-name').value = name;
            
            // Add category if not exists
            if (!payableCategories.includes(category)) {
                payableCategories.push(category);
                saveData();
            }
            
            // Re-populate categories to include new one
            const catSelect = document.getElementById('payable-category');
            catSelect.innerHTML = '<option value="Outros">Selecione ou deixe Outros</option>';
            payableCategories.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.innerText = cat;
                catSelect.appendChild(opt);
            });
            
            document.getElementById('payable-category').value = category;
            document.getElementById('payable-image').value = image;
            updatePayablePreview(image);
        }

        function updatePayablePreview(url) {
            const img = document.getElementById('payable-preview');
            if (url) {
                img.src = url;
                img.classList.remove('hidden');
            } else {
                img.classList.add('hidden');
            }
        }

        document.getElementById('payable-image').addEventListener('input', (e) => {
            updatePayablePreview(e.target.value);
        });

        document.getElementById('payable-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('payable-id').value;
            const name = document.getElementById('payable-name').value;
            const category = document.getElementById('payable-category').value;
            const dueDate = document.getElementById('payable-date').value;
            const total = parseFloat(document.getElementById('payable-total').value);
            let image = document.getElementById('payable-image').value;
            
            // Default Image Logic if empty
            if (!image) {
                const lowerName = name.toLowerCase();
                const lowerCat = category.toLowerCase();
                
                if (lowerCat.includes('energia') || lowerName.includes('luz') || lowerName.includes('energia') || lowerName.includes('enel') || lowerName.includes('cemig')) {
                     image = 'https://cdn-icons-png.flaticon.com/512/2933/2933861.png';
                } else if (lowerCat.includes('água') || lowerName.includes('agua') || lowerName.includes('sabesp') || lowerName.includes('cedae')) {
                     image = 'https://cdn-icons-png.flaticon.com/512/3105/3105807.png';
                } else if (lowerCat.includes('internet') || lowerName.includes('wifi') || lowerName.includes('vivo') || lowerName.includes('claro') || lowerName.includes('tim') || lowerName.includes('oi')) {
                     image = 'https://cdn-icons-png.flaticon.com/512/2059/2059338.png';
                } else if (lowerCat.includes('aluguel') || lowerName.includes('casa') || lowerName.includes('loja')) {
                     image = 'https://cdn-icons-png.flaticon.com/512/2558/2558072.png';
                } else if (lowerCat.includes('fornecedor') || lowerName.includes('fornecedor')) {
                     image = 'https://cdn-icons-png.flaticon.com/512/2821/2821868.png';
                } else if (lowerCat.includes('imposto') || lowerName.includes('imposto') || lowerName.includes('das') || lowerName.includes('darf')) {
                     image = 'https://cdn-icons-png.flaticon.com/512/2535/2535556.png';
                }
            }

            if (id) {
                const idx = payables.findIndex(p => p.id == id);
                if (idx > -1) {
                    payables[idx] = { ...payables[idx], name, category, dueDate, total, image };
                }
            } else {
                const newP = { id: Date.now(), name, image, category, dueDate, total, ledger: [] };
                payables.push(newP);
            }
            
            saveData();
            renderApagarPage();
            closePayableModal();
        });

        function deletePayable(id) {
            confirmDialog('Remover conta a pagar', 'Deseja remover esta conta?', { icon: 'warning' }).then(ok => {
                if (!ok) return;
                payables = payables.filter(p => p.id !== id);
                if (currentPayableId === id) currentPayableId = null;
                saveData();
                renderApagarPage();
            });
        }

        function editPayablePayment(paymentId) {
            const p = payables.find(x => x.id === currentPayableId);
            if (!p || !p.ledger) return;

            const payment = p.ledger.find(l => l.id === paymentId);
            if (!payment) return;

            const newAmountStr = prompt('Novo valor (R$):', payment.amount);
            if (newAmountStr === null) return;
            const newAmount = parseFloat(newAmountStr);
            if (isNaN(newAmount) || newAmount <= 0) {
                toastError('Valor inválido.');
                return;
            }

            const currentDatestr = payment.date && payment.date.length >= 10 ? payment.date.substring(0, 10) : ''; 
            const newDate = prompt('Nova data (AAAA-MM-DD):', currentDatestr);
            if (newDate === null) return;

            const newNote = prompt('Nova observação:', payment.note || '');
            if (newNote === null) return;

            payment.amount = newAmount;
            payment.date = newDate;
            payment.note = newNote;

            saveData();
            renderApagarDetail(currentPayableId);
            renderApagarGrid();
        }

        function deletePayablePayment(paymentId) {
            confirmDialog('Excluir pagamento', 'Excluir este pagamento?', { icon: 'warning' }).then(ok => {
                if (!ok) return;
                const p = payables.find(x => x.id === currentPayableId);
                if (!p || !p.ledger) return;
                p.ledger = p.ledger.filter(l => l.id !== paymentId);
                saveData();
                renderApagarDetail(currentPayableId);
                renderApagarGrid();
            });
        }

        function addPayablePayment() {
            if (!currentPayableId) return;
            const amount = parseFloat(document.getElementById('apagar-payment-amount').value);
            const date = document.getElementById('apagar-payment-date').value || new Date().toISOString();
            if (!amount || amount <= 0) {
                toastError('Informe um valor válido.');
                return;
            }
            const p = payables.find(x => x.id === currentPayableId);
            if (!p.ledger) p.ledger = [];
            p.ledger.push({ id: Date.now(), amount, date, note: 'Pagamento registrado' });
            document.getElementById('apagar-payment-amount').value = '';
            saveData();
            renderApagarDetail(currentPayableId);
            renderApagarGrid();
        }

        function addPayableCategory() {
            const name = prompt('Nome da nova categoria:');
            if (name && !payableCategories.includes(name)) {
                payableCategories.push(name);
                saveData();
                renderApagarCategories();
            }
        }

        function editPayableCategory(index) {
            const currentName = payableCategories[index];
            const newName = prompt('Editar categoria:', currentName);
            if (!newName) return;
            payableCategories[index] = newName;
            payables.forEach(p => { if (p.category === currentName) p.category = newName; });
            saveData();
            renderApagarPage();
        }

        function removePayableCategory(index) {
            const name = payableCategories[index];
            confirmDialog('Remover categoria', 'Os itens desta categoria serão movidos para "Outros".', { icon: 'warning' }).then(ok => {
                if (!ok) return;
                payableCategories.splice(index, 1);
                payables.forEach(p => { if (p.category === name) p.category = 'Outros'; });
                saveData();
                renderApagarPage();
            });
        }
        // --- CUSTOMERS (FIADO) ---
        function computeCustomerBalance(cust) {
            const debts = (cust.ledger || []).filter(l => l.type === 'fiado').reduce((acc, l) => acc + l.total, 0);
            const payments = (cust.ledger || []).filter(l => l.type === 'payment').reduce((acc, l) => acc + l.amount, 0);
            return debts - payments;
        }

        function renderFiadoPage() {
            renderCustomerList();
            if (currentCustomerId) {
                renderCustomerDetail(currentCustomerId);
            } else {
                document.getElementById('customer-detail').classList.add('hidden');
                document.getElementById('customer-detail-empty').classList.remove('hidden');
            }
            lucide.createIcons();
        }

        function renderCustomerList() {
            const listEl = document.getElementById('customers-list');
            const search = (document.getElementById('fiado-search')?.value || '').toLowerCase();
            listEl.innerHTML = '';
            const sorted = [...customers].sort((a, b) => computeCustomerBalance(b) - computeCustomerBalance(a));
            sorted.filter(c => c.name.toLowerCase().includes(search)).forEach(c => {
                const bal = computeCustomerBalance(c);
                const item = document.createElement('div');
                item.className = 'customer-card';
                item.innerHTML = `
                    <img class="avatar" src="${c.photo || 'https://via.placeholder.com/80?text=Foto'}" alt="Foto">
                    <div class="flex-1">
                        <div class="font-bold">${c.name}</div>
                        <div class="${bal > 0 ? 'balance-positive' : 'balance-zero'}">Saldo: ${formatCurrency(bal)}</div>
                    </div>
                    <span class="badge ${bal > 0 ? 'badge-debt' : 'badge-paid'}">${bal > 0 ? 'Devendo' : 'Quitado'}</span>
                `;
                item.onclick = () => renderCustomerDetail(c.id);
                listEl.appendChild(item);
            });
            lucide.createIcons();
        }

        function renderCustomerDetail(id) {
            currentCustomerId = id;
            const c = customers.find(x => x.id === id);
            if (!c) return;
            document.getElementById('customer-detail-empty').classList.add('hidden');
            const detail = document.getElementById('customer-detail');
            detail.classList.remove('hidden');
            document.getElementById('cust-photo').src = c.photo || 'https://via.placeholder.com/80?text=Foto';
            document.getElementById('cust-name').innerText = c.name;
            const bal = computeCustomerBalance(c);
            const limit = (c.creditLimit != null && c.creditLimit !== '') ? Number(c.creditLimit) : 0;
            document.getElementById('cust-balance').innerText = `Saldo Atual: ${formatCurrency(bal)}`;
            document.getElementById('cust-balance').className = bal > 0 ? 'balance-positive' : 'balance-zero';
            const limitEl = document.getElementById('cust-credit-limit');
            if (limitEl) limitEl.innerText = limit > 0 ? `Limite de crédito: ${formatCurrency(limit)}` : 'Limite: sem limite';
            
            const fiadosEl = document.getElementById('cust-ledger-fiado');
            const paysEl = document.getElementById('cust-ledger-payments');
            fiadosEl.innerHTML = '';
            paysEl.innerHTML = '';
            (c.ledger || []).filter(l => l.type === 'fiado').forEach(l => {
                const itemsSummary = l.items.map(i => `${i.qty}x ${i.name}`).join(', ');
                const row = document.createElement('div');
                row.className = 'ledger-entry';
                row.innerHTML = `
                    <div>
                        <div class="font-bold">${new Date(l.date).toLocaleString('pt-BR')}</div>
                        <div class="text-sm text-gray-600">Itens: ${itemsSummary}</div>
                    </div>
                    <div class="text-red-600 font-bold">${formatCurrency(l.total)}</div>
                `;
                fiadosEl.appendChild(row);
            });
            (c.ledger || []).filter(l => l.type === 'payment').forEach(l => {
                const row = document.createElement('div');
                row.className = 'ledger-entry';
                row.innerHTML = `
                    <div>
                        <div class="font-bold">${new Date(l.date).toLocaleString('pt-BR')}</div>
                        <div class="text-sm text-gray-600">${l.note || ''}</div>
                    </div>
                    <div class="text-green-600 font-bold">${formatCurrency(l.amount)}</div>
                `;
                paysEl.appendChild(row);
            });
        }

        function openCustomerModal(id = null) {
            const modal = document.getElementById('customer-modal');
            document.getElementById('customer-modal-id').value = id || '';
            document.getElementById('customer-modal-title').innerText = id ? 'Editar Cliente' : 'Adicionar Cliente';
            const nameEl = document.getElementById('cust-modal-name');
            const phoneEl = document.getElementById('cust-modal-phone');
            const emailEl = document.getElementById('cust-modal-email');
            const photoPrev = document.getElementById('cust-modal-photo-preview');
            const limitEl = document.getElementById('cust-modal-credit-limit');
            nameEl.value = '';
            phoneEl.value = '';
            emailEl.value = '';
            limitEl.value = '0';
            photoPrev.innerHTML = '';
            if (id) {
                const c = customers.find(x => x.id === id);
                if (c) {
                    nameEl.value = c.name || '';
                    phoneEl.value = c.phone || '';
                    emailEl.value = c.email || '';
                    limitEl.value = (c.creditLimit != null && c.creditLimit !== '') ? Number(c.creditLimit) : '0';
                    if (c.photo) photoPrev.innerHTML = `<img src="${c.photo}" alt="Foto" width="100" height="100" style="border-radius:8px;">`;
                }
            }
            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        function closeCustomerModal() {
            document.getElementById('customer-modal').classList.add('hidden');
        }

        function saveCustomer() {
            const idVal = document.getElementById('customer-modal-id').value;
            const name = document.getElementById('cust-modal-name').value.trim();
            const phone = document.getElementById('cust-modal-phone').value.trim();
            const email = document.getElementById('cust-modal-email').value.trim();
            const creditLimit = parseFloat(document.getElementById('cust-modal-credit-limit').value) || 0;
            const fileInput = document.getElementById('cust-modal-photo-input');
            const file = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
            const doSave = async (photoData) => {
                if (!name) return;
                try {
                    if (idVal) {
                        const data = { name, phone, email, creditLimit };
                        if (photoData) data.photo = photoData;
                        await FirestoreService.updateCustomer(idVal, data);
                        toastSuccess('Cliente atualizado!');
                    } else {
                        const newCust = { name, phone, email, photo: photoData || '', ledger: [], creditLimit };
                        await FirestoreService.addCustomer(newCust);
                        toastSuccess('Cliente criado!');
                    }
                    closeCustomerModal();
                } catch(e) {
                    console.error(e);
                    toastError('Erro ao salvar cliente');
                }
            };
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => doSave(e.target.result);
                reader.readAsDataURL(file);
            } else {
                doSave(null);
            }
        }

        function deleteCustomer(id) {
            confirmDialog('Remover cliente', 'Isso não remove registros de vendas existentes, apenas o cadastro.', { icon: 'warning' }).then(ok => {
                if (!ok) return;
                customers = customers.filter(c => c.id !== id);
                if (currentCustomerId === id) currentCustomerId = null;
                saveData();
                renderFiadoPage();
            });
        }

        function addCustomerPayment() {
            if (!currentCustomerId) return;
            const amount = parseFloat(document.getElementById('payment-amount').value);
            if (!amount || amount <= 0) {
                toastError('Informe um valor válido.');
                return;
            }
            const cust = customers.find(c => c.id === currentCustomerId);
            if (!cust.ledger) cust.ledger = [];
            cust.ledger.push({ id: Date.now(), type: 'payment', date: new Date().toISOString(), amount, note: 'Pagamento registrado manualmente' });
            document.getElementById('payment-amount').value = '';
            saveData();
            renderCustomerDetail(currentCustomerId);
            renderCustomerList();
        }

        function addFiadoEntry(customerId, sale) {
            const cust = customers.find(c => c.id === customerId);
            if (!cust) return;
            if (!cust.ledger) cust.ledger = [];
            cust.ledger.push({ id: sale.id, type: 'fiado', date: sale.date, items: sale.items, total: sale.total });
        }
        // --- SETTINGS (PAYMENT METHODS & CATEGORIES) ---
        function renderSettings() {
            // Render Payment Methods
            const list = document.getElementById('payment-methods-list');
            list.innerHTML = '';
            
            paymentMethods.forEach((method, index) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-gray-50 p-3 rounded border';
                li.innerHTML = `
                    <span>${method}</span>
                    <div class="flex gap-2">
                        <button class="text-blue-500 hover:text-blue-700" onclick="editPaymentMethod(${index})">
                            <i data-lucide="edit-2" style="width: 16px;"></i>
                        </button>
                        <button class="text-red-500 hover:text-red-700" onclick="removePaymentMethod(${index})">
                            <i data-lucide="trash" style="width: 16px;"></i>
                        </button>
                    </div>
                `;
                list.appendChild(li);
            });

            // Render Categories
            const listCat = document.getElementById('categories-list');
            if (listCat) {
                listCat.innerHTML = '';
                categories.forEach((cat, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-50 p-3 rounded border';
                    li.innerHTML = `
                        <span>${cat}</span>
                        <div class="flex gap-2">
                            <button class="text-blue-500 hover:text-blue-700" onclick="editCategory(${index})">
                                <i data-lucide="edit-2" style="width: 16px;"></i>
                            </button>
                            <button class="text-red-500 hover:text-red-700" onclick="removeCategory(${index})">
                                <i data-lucide="trash" style="width: 16px;"></i>
                            </button>
                        </div>
                    `;
                    listCat.appendChild(li);
                });
            }
            
            // Pix Config
            document.getElementById('config-pix-key').value = pixConfig.key || '';
            document.getElementById('config-pix-name').value = pixConfig.name || '';
            const qrPrev = document.getElementById('config-pix-qr-preview');
            if (qrPrev) {
                qrPrev.innerHTML = pixConfig.qrImage ? `<img src="${pixConfig.qrImage}" alt="QR Code Pix" width="150" height="150">` : '';
            }
            // Integrations
            document.getElementById('config-stripe-link').value = integrations.stripeLink || '';
            document.getElementById('config-mp-link').value = integrations.mpLink || '';
            // Users
            const ulist = document.getElementById('users-list');
            ulist.innerHTML = '';
            (users || []).forEach(u => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-gray-50 p-3 rounded border';
                li.innerHTML = `
                    <div>
                        <div class="font-bold">${u.name} <span class="text-xs text-gray-500">(${u.role})</span></div>
                        <div class="text-sm text-gray-600">${u.email}</div>
                    </div>
                    <div class="flex gap-2">
                        <button class="text-blue-500 hover:text-blue-700" onclick="editUser(${u.id})"><i data-lucide="edit-2" style="width: 16px;"></i></button>
                        <button class="text-red-500 hover:text-red-700" onclick="removeUser(${u.id})"><i data-lucide="trash" style="width: 16px;"></i></button>
                    </div>
                `;
                ulist.appendChild(li);
            });
            
            // Load NF-e config
            loadNFeConfig();
            
            const rw = document.getElementById('receipt-width');
            const rc = document.getElementById('receipt-company');
            const ra = document.getElementById('receipt-address');
            const rt = document.getElementById('receipt-title');
            const rf = document.getElementById('receipt-footer');
            const rsh = document.getElementById('receipt-show-header');
            const rsb = document.getElementById('receipt-show-border');
            if (rw) rw.value = receiptConfig.width || 320;
            if (rc) rc.value = receiptConfig.companyName || '';
            if (ra) ra.value = receiptConfig.addressLine || '';
            if (rt) rt.value = receiptConfig.title || '';
            if (rf) rf.value = receiptConfig.footerText || '';
            if (rsh) rsh.checked = !!receiptConfig.showHeader;
            if (rsb) rsb.checked = !!receiptConfig.showBorder;

            lucide.createIcons();
        }
        
        function saveReceiptConfig() {
            const width = parseInt(document.getElementById('receipt-width').value) || 320;
            const companyName = document.getElementById('receipt-company').value || '';
            const addressLine = document.getElementById('receipt-address').value || '';
            const title = document.getElementById('receipt-title').value || '';
            const footerText = document.getElementById('receipt-footer').value || '';
            const showHeader = document.getElementById('receipt-show-header').checked;
            const showBorder = document.getElementById('receipt-show-border').checked;
            receiptConfig = { width, companyName, addressLine, title, footerText, showHeader, showBorder };
            localStorage.setItem(STORAGE_KEY_RECEIPT, JSON.stringify(receiptConfig));
            syncToServer();
            toastSuccess('Configuração de recibo salva!');
        }
        
        function previewReceiptConfig() {
            const mockSale = {
                id: 999999,
                date: new Date().toISOString(),
                items: [{ name: 'Produto Exemplo', qty: 2, price: 10 }],
                total: 20,
                paymentMethod: 'Dinheiro'
            };
            const sale = mockSale;
            let content = `
                <div style="font-family: 'Courier New', monospace; padding: 20px; width: ${receiptConfig.width || 320}px; margin: 0 auto; ${receiptConfig.showBorder ? 'border: 1px solid #000;' : ''} background: #fff;">
            `;
            if (receiptConfig.showHeader) {
                content += `
                    <div style="text-align: center; margin-bottom: 10px;">
                        <h2 style="margin: 0; font-size: 16px;">${receiptConfig.companyName || ''}</h2>
                        <p style="margin: 5px 0; font-size: 12px;">${receiptConfig.addressLine || ''}</p>
                    </div>
                `;
            }
            content += `
                <div style="border-top: 1px dashed #000; border-bottom: 1px dashed #000; padding: 5px 0; margin: 10px 0; text-align: center;">
                    <strong style="font-size: 14px;">${receiptConfig.title || 'CUPOM NÃO FISCAL'}</strong>
                </div>
                <p style="font-size: 12px; margin: 5px 0;">Data: ${new Date(sale.date).toLocaleString()}</p>
                <p style="font-size: 12px; margin: 5px 0;">Venda: #${sale.id}</p>
                <div style="border-bottom: 1px dashed #000; margin: 10px 0;"></div>
                <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                    <tr style="text-align: left;">
                        <th style="padding-bottom: 5px;">ITEM</th>
                        <th style="text-align: right; padding-bottom: 5px;">TOTAL</th>
                    </tr>
            `;
            sale.items.forEach(item => {
                content += `
                    <tr>
                        <td style="padding: 2px 0;">${item.name}<br><span style="font-size: 10px;">${item.qty} x ${formatCurrency(item.price)}</span></td>
                        <td style="text-align: right; vertical-align: top; padding: 2px 0;">${formatCurrency(item.qty * item.price)}</td>
                    </tr>
                `;
            });
            content += `
                    </table>
                    <div style="border-bottom: 1px dashed #000; margin: 10px 0;"></div>
                    <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 14px;">
                        <span>TOTAL</span>
                        <span>${formatCurrency(sale.total)}</span>
                    </div>
                    <div style="margin-top: 5px; font-size: 12px;">
                        <p style="margin: 2px 0;">Forma de Pagto: ${sale.paymentMethod}</p>
                    </div>
                    <div style="border-top: 1px dashed #000; margin-top: 15px; padding-top: 10px; text-align: center; font-size: 12px;">
                        <p>Obrigado pela preferência!</p>
                        <p>Volte sempre!</p>
                        <p>${receiptConfig.footerText || ''}</p>
                    </div>
                </div>
            `;
            const win = window.open('', '', 'width=400,height=600');
            win.document.write('<html><head><title>Visualizar Recibo</title></head><body style="background: #f0f0f0; padding: 20px;">' + content + '</body></html>');
            win.document.close();
        }
        
        function testBackup() {
            try {
                fetch(getApiBase() + '/api/backup/snapshot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        products, paymentMethods, categories, sales, customers, payables, payableCategories
                    })
                }).then(r => r.json()).then(d => {
                    toastSuccess('Backup criado com sucesso!');
                }).catch(() => toastError('Falha ao criar backup'));
            } catch (e) {
                toastError('Erro ao chamar backup');
            }
        }
        
        function downloadLatestBackup() {
            fetch(getApiBase() + '/api/backup/latest')
                .then(async (r) => {
                    if (!r.ok) throw new Error('not_found');
                    const text = await r.text();
                    const blob = new Blob([text], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'db.json';
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);
                })
                .catch(() => toastError('Nenhum backup encontrado'));
        }
        
        function restoreBackupFromFile(ev) {
            const file = ev.target.files && ev.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const data = JSON.parse(String(reader.result || '{}'));
                    if (data.products) localStorage.setItem(STORAGE_KEY_PRODUCTS, JSON.stringify(data.products));
                    if (data.paymentMethods) localStorage.setItem(STORAGE_KEY_PAYMENT, JSON.stringify(data.paymentMethods));
                    if (data.categories) localStorage.setItem(STORAGE_KEY_CATEGORIES, JSON.stringify(data.categories));
                    if (data.sales) localStorage.setItem(STORAGE_KEY_SALES, JSON.stringify(data.sales));
                    if (data.customers) localStorage.setItem(STORAGE_KEY_CUSTOMERS, JSON.stringify(data.customers));
                    if (data.payables) localStorage.setItem(STORAGE_KEY_PAYABLES, JSON.stringify(data.payables));
                    if (data.payableCategories) localStorage.setItem(STORAGE_KEY_PAYABLE_CATEGORIES, JSON.stringify(data.payableCategories));
                    toastSuccess('Backup restaurado com sucesso! Recarregando...');
                    location.reload();
                } catch {
                    toastError('Arquivo de backup inválido');
                }
            };
            reader.onerror = () => toastError('Falha ao ler o arquivo de backup');
            reader.readAsText(file);
        }

        function saveIntegrations() {
            const stripeLink = document.getElementById('config-stripe-link').value;
            const mpLink = document.getElementById('config-mp-link').value;
            integrations = { stripeLink, mpLink };
            localStorage.setItem(STORAGE_KEY_INTEGRATIONS, JSON.stringify(integrations));
            syncToServer();
            toastSuccess('Integrações salvas com sucesso!');
        }

        function openUserModal(id = null) {
            const modal = document.getElementById('user-modal');
            document.getElementById('user-modal-id').value = id || '';
            document.getElementById('user-modal-title').innerText = id ? 'Editar Usuário' : 'Adicionar Usuário';
            const nameEl = document.getElementById('user-name');
            const emailEl = document.getElementById('user-email');
            const passEl = document.getElementById('user-password');
            const roleEl = document.getElementById('user-role');
            const photoPrev = document.getElementById('user-photo-preview');
            nameEl.value = '';
            emailEl.value = '';
            passEl.value = '';
            roleEl.value = 'caixa';
            photoPrev.innerHTML = '';
            if (id) {
                const u = users.find(x => x.id === id);
                if (u) {
                    nameEl.value = u.name || '';
                    emailEl.value = u.email || '';
                    passEl.value = u.password || '';
                    roleEl.value = u.role || 'caixa';
                    if (u.photo) photoPrev.innerHTML = `<img src="${u.photo}" alt="Foto" width="100" height="100" style="border-radius:8px;">`;
                }
            }
            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        function closeUserModal() {
            document.getElementById('user-modal').classList.add('hidden');
        }

        function saveUserForm() {
            const idVal = document.getElementById('user-modal-id').value;
            const name = document.getElementById('user-name').value.trim();
            const email = document.getElementById('user-email').value.trim();
            const password = document.getElementById('user-password').value.trim();
            const role = document.getElementById('user-role').value;
            const fileInput = document.getElementById('user-photo-input');
            const file = fileInput.files[0];

            const doSave = (photoData) => {
                if (!name || !email || !password) {
                    toastError('Preencha nome, email e senha.');
                    return;
                }
                if (idVal) {
                    const idx = users.findIndex(u => u.id === parseInt(idVal));
                    if (idx > -1) {
                        users[idx] = { ...users[idx], name, email, password, role, photo: photoData ?? users[idx].photo };
                    }
                } else {
                    const id = Date.now();
                    users.push({ id, name, email, password, role, photo: photoData || '' });
                }
                localStorage.setItem(STORAGE_KEY_USERS, JSON.stringify(users));
                syncToServer();
                closeUserModal();
                renderSettings();
            };

            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => doSave(e.target.result);
                reader.readAsDataURL(file);
            } else {
                doSave(null);
            }
        }

        function addUser() {
            openUserModal();
        }

        function editUser(id) {
            openUserModal(id);
        }

        function removeUser(id) {
            confirmDialog('Remover usuário', 'Deseja remover este usuário?', { icon: 'warning' }).then(ok => {
                if (!ok) return;
                users = users.filter(u => u.id !== id);
                localStorage.setItem(STORAGE_KEY_USERS, JSON.stringify(users));
                syncToServer();
                renderSettings();
            });
        }
        
        function savePixConfig() {
            const key = document.getElementById('config-pix-key').value;
            const name = document.getElementById('config-pix-name').value;
            const fileInput = document.getElementById('config-pix-qr-file');
            const file = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
            const save = (qrImage) => {
                pixConfig = { key, name, qrImage: qrImage || pixConfig.qrImage || '' };
                localStorage.setItem(STORAGE_KEY_PIX, JSON.stringify(pixConfig));
                syncToServer();
                const qrPrev = document.getElementById('config-pix-qr-preview');
                if (qrPrev) {
                    qrPrev.innerHTML = pixConfig.qrImage ? `<img src="${pixConfig.qrImage}" alt="QR Code Pix" width="150" height="150">` : '';
                }
                toastSuccess('Configuração Pix salva com sucesso!');
            };
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => save(e.target.result);
                reader.readAsDataURL(file);
            } else {
                save(null);
            }
        }

        // Funções NF-e
        function toggleNFe() {
            const toggle = document.getElementById('nfe-toggle');
            const fields = document.getElementById('nfe-config-fields');
            
            if (toggle.checked) {
                fields.classList.remove('hidden');
                loadNFeConfig();
            } else {
                fields.classList.add('hidden');
            }
        }

        function loadNFeConfig() {
            const saved = localStorage.getItem(STORAGE_KEY_NFE);
            if (saved) {
                const config = JSON.parse(saved);
                document.getElementById('nfe-cnpj').value = config.cnpj || '';
                document.getElementById('nfe-ie').value = config.ie || '';
                document.getElementById('nfe-company-name').value = config.companyName || '';
                document.getElementById('nfe-address').value = config.address || '';
                document.getElementById('nfe-series').value = config.series || '1';
                document.getElementById('nfe-start-number').value = config.startNumber || '1';
                document.getElementById('nfe-environment').value = config.environment || 'homologacao';
                document.getElementById('nfe-toggle').checked = config.enabled || false;
                
                if (config.enabled) {
                    document.getElementById('nfe-config-fields').classList.remove('hidden');
                }
            }
        }

        function saveNFeConfig() {
            const config = {
                enabled: document.getElementById('nfe-toggle').checked,
                cnpj: document.getElementById('nfe-cnpj').value,
                ie: document.getElementById('nfe-ie').value,
                companyName: document.getElementById('nfe-company-name').value,
                address: document.getElementById('nfe-address').value,
                series: document.getElementById('nfe-series').value,
                startNumber: document.getElementById('nfe-start-number').value,
                environment: document.getElementById('nfe-environment').value,
                currentNumber: document.getElementById('nfe-start-number').value
            };
            
            localStorage.setItem(STORAGE_KEY_NFE, JSON.stringify(config));
            syncToServer();
            toastSuccess('Configurações NF-e salvas com sucesso!');
        }

        function previewNFe(sale = null) {
            const config = JSON.parse(localStorage.getItem(STORAGE_KEY_NFE) || '{}');
            
            // Atualizar preview com dados da empresa
            document.getElementById('preview-company-name').textContent = config.companyName || '[Nome da Empresa]';
            document.getElementById('preview-cnpj').textContent = config.cnpj || '00.000.000/0001-00';
            document.getElementById('preview-ie').textContent = config.ie || '000.000.000.000';
            document.getElementById('preview-address').textContent = config.address || '[Endereço completo]';
            document.getElementById('preview-nfe-series').textContent = config.series || '1';
            document.getElementById('preview-environment').textContent = (config.environment === 'producao' ? 'PRODUÇÃO' : 'HOMOLOGAÇÃO');
            document.getElementById('preview-date').textContent = new Date().toLocaleString('pt-BR');
            document.getElementById('preview-nfe-number').textContent = (config.currentNumber || '1').toString().padStart(6, '0');

            // Atualizar com dados da venda, se houver
            if (sale) {
                const productsTbody = document.getElementById('preview-products');
                productsTbody.innerHTML = '';
                sale.items.forEach((item, index) => {
                    productsTbody.innerHTML += `
                        <tr>
                            <td>${(index + 1).toString().padStart(3, '0')}</td>
                            <td>${item.name}</td>
                            <td class="text-center">${item.qty}</td>
                            <td class="text-right">${formatCurrency(item.price)}</td>
                            <td class="text-right">${formatCurrency(item.price * item.qty)}</td>
                        </tr>
                    `;
                });

                // Atualizar totais (simulação)
                const total = sale.total;
                document.querySelector('#preview-products + .border-t .grid-cols-2 > div:first-child p:nth-child(2)').textContent = `Base ICMS: ${formatCurrency(total)}`;
                document.querySelector('#preview-products + .border-t .grid-cols-2 > div:first-child p:nth-child(3)').textContent = `Valor ICMS: ${formatCurrency(total * 0.18)}`; // Exemplo 18%
                document.querySelector('#preview-products + .border-t .grid-cols-2 > div:last-child p:nth-child(2)').textContent = `Total Produtos: ${formatCurrency(total)}`;
                document.querySelector('#preview-products + .border-t .grid-cols-2 > div:last-child p:nth-child(4)').textContent = `Total NF-e: ${formatCurrency(total)}`;
                document.querySelector('#preview-products + .border-t .grid-cols-2 > div:last-child p:last-child').textContent = `Valor a Pagar: ${formatCurrency(total)}`;
                
                // Adicionar listener para o botão de gerar NF-e com o ID da venda
                const generateBtn = document.querySelector('#nfe-preview-modal .btn-primary');
                generateBtn.onclick = () => generateNFe(sale.id);

            } else {
                // Se não houver venda, usar dados de exemplo
                document.getElementById('preview-products').innerHTML = `
                    <tr>
                        <td>001</td>
                        <td>Produto Exemplo 1</td>
                        <td class="text-center">2</td>
                        <td class="text-right">R$ 10,00</td>
                        <td class="text-right">R$ 20,00</td>
                    </tr>
                    <tr>
                        <td>002</td>
                        <td>Produto Exemplo 2</td>
                        <td class="text-center">1</td>
                        <td class="text-right">R$ 15,00</td>
                        <td class="text-right">R$ 15,00</td>
                    </tr>
                `;
            }
            
            // Abrir modal
            document.getElementById('nfe-preview-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeNFePreview() {
            document.getElementById('nfe-preview-modal').classList.add('hidden');
        }

        function generateNFe(saleId) {
            const config = JSON.parse(localStorage.getItem(STORAGE_KEY_NFE) || '{}');
            const sale = sales.find(s => s.id === saleId);

            if (!sale) {
                toastError('Erro: Venda não encontrada para gerar NF-e.');
                return;
            }

            // Simulação de emissão
            toastSuccess(`NF-e (Série ${config.series}, Nº ${config.currentNumber}) gerada com sucesso para a venda #${saleId}!`);
            
            // Incrementar número da nota e salvar
            config.currentNumber = (parseInt(config.currentNumber) || 0) + 1;
            localStorage.setItem(STORAGE_KEY_NFE, JSON.stringify(config));
            syncToServer();

            closeNFePreview();
        }

        function addCategory() {
            const name = prompt('Nome da nova categoria:');
            if (name && !categories.includes(name)) {
                categories.push(name);
                saveData();
                renderSettings();
            }
        }

        function editCategory(index) {
            const currentName = categories[index];
            const newName = prompt('Editar categoria:', currentName);
            if (newName && newName !== currentName) {
                if (categories.includes(newName)) {
                    toastWarning('Esta categoria já existe!');
                    return;
                }
                categories[index] = newName;
                saveData();
                renderSettings();
            }
        }

        function removeCategory(index) {
            confirmDialog('Remover categoria', 'Produtos nesta categoria precisarão ser atualizados.', { icon: 'warning' }).then(ok => {
                if (!ok) return;
                categories.splice(index, 1);
                saveData();
                renderSettings();
            });
        }

        function addPaymentMethod() {
            const name = prompt('Nome da nova forma de pagamento:');
            if (name && !paymentMethods.includes(name)) {
                paymentMethods.push(name);
                saveData();
                renderSettings();
            }
        }

        function editPaymentMethod(index) {
            const currentName = paymentMethods[index];
            const newName = prompt('Editar forma de pagamento:', currentName);
            if (newName && newName !== currentName) {
                if (paymentMethods.includes(newName)) {
                    toastWarning('Esta forma de pagamento já existe!');
                    return;
                }
                paymentMethods[index] = newName;
                saveData();
                renderSettings();
            }
        }

        function removePaymentMethod(index) {
            confirmDialog('Remover forma de pagamento', 'Remover esta forma de pagamento?', { icon: 'warning' }).then(ok => {
                if (!ok) return;
                paymentMethods.splice(index, 1);
                saveData();
                renderSettings();
            });
        }

        function resetSystem() {
            confirmDialog('ATENÇÃO', 'Isso apagará TODOS os seus produtos, vendas e configurações. Deseja continuar?', { icon: 'warning', danger: true }).then(ok => {
                if (!ok) return;
                localStorage.removeItem(STORAGE_KEY_PRODUCTS);
                localStorage.removeItem(STORAGE_KEY_PAYMENT);
                localStorage.removeItem(STORAGE_KEY_CATEGORIES);
                localStorage.removeItem(STORAGE_KEY_SALES);
                const empty = { products: [], categories: initialCategories, paymentMethods: initialPayments, sales: [], customers: [], payables: [], payableCategories: [...initialCategories], users: [{ id: 1, name: 'Administrador', email: 'admin@pdv.com', password: '123456', role: 'admin' }], integrations: { stripeLink: '', mpLink: '' }, receiptConfig, pixConfig: { key: '', name: '' }, nfeConfig: {} };
                fetch(getApiBase() + '/api/db', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(empty) }).finally(() => location.reload());
            });
        }

        // Utils
        function formatCurrency(value) {
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        // --- INIT ---
        loadData().then(() => {
            document.getElementById('current-date').innerText = new Date().toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            lucide.createIcons();
            try {
                updateDashboard();
            } catch (e) {
                console.error('Erro ao atualizar dashboard:', e);
            }
        });


        function printReceipt(saleId, autoPrint = false) {
            const sale = sales.find(s => s.id === saleId);
            if (!sale) return;
            
            let content = `
                <div style="font-family: 'Courier New', monospace; padding: 20px; width: ${receiptConfig.width || 320}px; margin: 0 auto; ${receiptConfig.showBorder ? 'border: 1px solid #000;' : ''} background: #fff;">
                    ${receiptConfig.showHeader ? `
                    <div style="text-align: center; margin-bottom: 10px;">
                        <h2 style="margin: 0; font-size: 16px;">${receiptConfig.companyName || ''}</h2>
                        <p style="margin: 5px 0; font-size: 12px;">${receiptConfig.addressLine || ''}</p>
                    </div>` : ''}
                    <div style="border-top: 1px dashed #000; border-bottom: 1px dashed #000; padding: 5px 0; margin: 10px 0; text-align: center;">
                        <strong style="font-size: 14px;">${receiptConfig.title || 'CUPOM NÃO FISCAL'}</strong>
                    </div>
                    <p style="font-size: 12px; margin: 5px 0;">Data: ${new Date(sale.date).toLocaleString()}</p>
                    <p style="font-size: 12px; margin: 5px 0;">Venda: #${sale.id}</p>
                    <div style="border-bottom: 1px dashed #000; margin: 10px 0;"></div>
                    <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                        <tr style="text-align: left;">
                            <th style="padding-bottom: 5px;">ITEM</th>
                            <th style="text-align: right; padding-bottom: 5px;">TOTAL</th>
                        </tr>
            `;
            
            sale.items.forEach(item => {
                content += `
                    <tr>
                        <td style="padding: 2px 0;">${item.name}<br><span style="font-size: 10px;">${item.qty} x ${formatCurrency(item.price)}</span></td>
                        <td style="text-align: right; vertical-align: top; padding: 2px 0;">${formatCurrency(item.qty * item.price)}</td>
                    </tr>
                `;
            });
            
            content += `
                    </table>
                    <div style="border-bottom: 1px dashed #000; margin: 10px 0;"></div>
                    <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 14px;">
                        <span>TOTAL</span>
                        <span>${formatCurrency(sale.total)}</span>
                    </div>
                    <div style="margin-top: 5px; font-size: 12px;">
                        <p style="margin: 2px 0;">Forma de Pagto: ${sale.paymentMethod}</p>
                    </div>
                    <div style="border-top: 1px dashed #000; margin-top: 15px; padding-top: 10px; text-align: center; font-size: 12px;">
                        <p>Obrigado pela preferência!</p>
                        <p>Volte sempre!</p>
                        <p>${receiptConfig.footerText || ''}</p>
                    </div>
                </div>
            `;
            
            const win = window.open('', '', 'width=400,height=600');
            win.document.write('<html><head><title>Imprimir Cupom</title></head><body style="background: #f0f0f0; padding: 20px;">' + content + '</body></html>');
            win.document.close();
            
            if (autoPrint) {
                setTimeout(() => { 
                    win.print(); 
                    // win.close(); 
                }, 500);
            }
        }

        // --- POST SALE OPTIONS ---
        let currentPostSaleId = null;

        function showPostSaleOptions(saleId) {
            currentPostSaleId = saleId;
            document.getElementById('post-sale-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closePostSaleModal() {
            document.getElementById('post-sale-modal').classList.add('hidden');
            currentPostSaleId = null;
        }

        function handlePrintReceipt() {
            if (currentPostSaleId) {
                printReceipt(currentPostSaleId, true);
            }
        }

        function handleViewReceipt() {
            if (currentPostSaleId) {
                printReceipt(currentPostSaleId, false);
            }
        }

        function emitNfe(saleId) {
            // Simulation of NF-e emission
            const sale = sales.find(s => s.id === saleId);
            if (!sale) return;

            // Show loading simulation
            Swal.fire({
                title: 'Sistema Fiscal',
                html: '<p>Iniciando transmissão para SEFAZ...</p><p>[====================] 100%</p><p>Autorizando Nota Fiscal para Venda #' + saleId + '...</p><p><strong>SUCESSO:</strong> NF-e emitida e autorizada!</p>',
                icon: 'success',
                width: 440
            });
            
            // Add to notifications
            // addNotification('Fiscal', `NF-e emitida com sucesso para a venda #${saleId}. Valor: ${formatCurrency(sale.total)}`);
        }
    </script>
</body>
</html>
